name: "CD: Hydrate Manifests"

on:
  push:
    branches:
      - main
    paths:
      - "kubernetes/applications/**"
      - "kubernetes/components/**"
      - ".github/workflows/cd-hydrate.yaml"

permissions:
  contents: write

jobs:
  hydrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: "v3.13.1"

      - name: Install Kustomize
        uses: yokawasa/action-setup-kube-tools@v0.13.1
        with:
          kustomize: "5.7.0"

      - name: Hydrate Manifests
        run: |
          mkdir -p dist/applications dist/components

          # Helper function to hydrate
          hydrate() {
            local type=$1
            local path=$2
            local name=$(basename $(dirname $(dirname $path)))
            local env=$(basename $path)

            # Process both prod and dev overlays
            if [[ "$env" == "prod" || "$env" == "dev" ]]; then
              echo "Hydrating $type/$name ($env)..."
              # Clean output directory to ensure determinism (remove stale files)
              rm -rf dist/$env/$type/$name
              mkdir -p dist/$env/$type/$name
              kustomize build --enable-helm $path > dist/$env/$type/$name/manifest.yaml || echo "Failed to hydrate $name"
            fi
          }

          # Check applications
          if [ -d "kubernetes/applications" ]; then
            find kubernetes/applications -name kustomization.yaml | while read kustomization; do
              hydrate "applications" $(dirname $kustomization)
            done
          fi

          # Check components
          if [ -d "kubernetes/components" ]; then
             find kubernetes/components -name kustomization.yaml | while read kustomization; do
              hydrate "components" $(dirname $kustomization)
            done
          fi

      - name: Deploy to Hydrated Branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: hydrated
          force_orphan: true
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "chore: hydrate manifests from main"
