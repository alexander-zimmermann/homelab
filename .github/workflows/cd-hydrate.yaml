name: "CD: Hydrate Manifests"

on:
  push:
    branches:
      - main
    paths:
      - "kubernetes/applications/**"
      - "kubernetes/components/**"
      - ".github/workflows/cd-hydrate.yaml"

permissions:
  contents: write

jobs:
  hydrate-manifests:
    name: Hydrate Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v6

      - name: Install CLI Tools
        uses: alexellis/arkade-get@master
        with:
          kustomize: v5.8.1
          helm: v4.1.1

      - name: Hydrate Manifests
        run: |
          set -euo pipefail
          mkdir -p dist/applications dist/components

          # Helper function to hydrate
          hydrate() {
            local type=$1
            local path=$2
            local name=$(basename $(dirname $(dirname $path)))
            local env=$(basename $path)

            # Process both prod and dev overlays
            if [[ "$env" == "prod" || "$env" == "dev" ]]; then
              echo "::group::Hydrating $name ($env)"
              # Clean output directory to ensure determinism (remove stale files)
              rm -rf dist/$env/$type/$name
              mkdir -p dist/$env/$type/$name

              if kustomize build --enable-helm $path > dist/$env/$type/$name/manifest.yaml; then
                echo "âœ… Hydrated $type/$name ($env)"
              else
                echo "::error::Failed to hydrate $name"
                exit 1
              fi
              echo "::endgroup::"
            fi
          }

          # Check applications
          if [ -d "kubernetes/applications" ]; then
            find kubernetes/applications -name kustomization.yaml | while read kustomization; do
              hydrate "applications" $(dirname $kustomization)
            done
          fi

          # Check components
          if [ -d "kubernetes/components" ]; then
             find kubernetes/components -name kustomization.yaml | while read kustomization; do
              hydrate "components" $(dirname $kustomization)
            done
          fi

      - name: Deploy to Hydrated Branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: hydrated
          force_orphan: true
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "chore: hydrate manifests from main"
