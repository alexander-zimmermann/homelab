name: "CD: Render Bootstrap"

on:
  push:
    branches:
      - main
    paths:
      - "kubernetes/bootstrap/**"
      - ".github/workflows/cd-render-bootstrap.yaml"

permissions:
  contents: write

jobs:
  render-manifests:
    name: Render Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v6

      - name: Install CLI Tools
        uses: alexellis/arkade-get@master
        with:
          kustomize: v5.8.1
          helm: v4.1.1

      - name: Render Manifests
        run: |
          set -euo pipefail
          mkdir -p dist/prod dist/dev

          echo "::group::Rendering Prod"
          kustomize build --enable-helm kubernetes/bootstrap/cilium/overlays/prod > dist/prod/cilium.yaml
          kustomize build --enable-helm kubernetes/bootstrap/gitops-controller/overlays/prod > dist/prod/argocd.yaml
          echo "::endgroup::"

          echo "::group::Rendering Dev"
          kustomize build --enable-helm kubernetes/bootstrap/cilium/overlays/dev > dist/dev/cilium.yaml
          kustomize build --enable-helm kubernetes/bootstrap/gitops-controller/overlays/dev > dist/dev/argocd.yaml
          echo "::endgroup::"

      - name: Deploy to Bootstrap Branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: bootstrap
          force_orphan: true
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "chore: update bootstrap manifests"
