name: "CI: ArgoCD Diff Preview"

on:
  pull_request:
    branches: [ main ]
    paths:
      - "kubernetes/applications/**"
      - "kubernetes/components/**"
      - "kubernetes/bootstrap/**"
      - ".github/workflows/ci-diff.yaml"
      - ".github/scripts/hydrate.sh"

permissions:
  contents: read
  pull-requests: write

jobs:
  generate-diff:
    name: Generate Diff
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          path: pull-request

      - name: Checkout base branch
        uses: actions/checkout@v6
        with:
          ref: hydrated
          path: main

      - name: Install CLI Tools
        uses: alexellis/arkade-get@master
        with:
          kustomize: v5.8.1

      - name: Hydrate Applications (PR)
        run: pull-request/.github/scripts/hydrate.sh --source pull-request --dest pull-request/hydrated --envs prod

      - name: Render ApplicationSets (PR)
        shell: bash
        run: |
          echo "::group::Render ApplicationSets"
          echo "Rendering PR Branch ApplicationSets..."
          kustomize build --enable-helm pull-request/kubernetes/bootstrap/gitops-controller/overlays/prod > pull-request/rendered-apps.yaml
          echo "::endgroup::"

      - name: Patch ApplicationSets (PR)
        shell: bash
        run: |
          echo "::group::Patch ApplicationSets"

          # Relax Permissions for Container Access
          chmod -R a+rwX pull-request

          # Patch ApplicationSets to point to local hydrated files
          # The container looks for files at: /target-branch/hydrated/...

          # RepoURL: https://github.com/... -> file:///target-branch
          # Path: prod/ -> hydrated/
          # TargetRevision: hydrated -> HEAD

          # Use -E for extended regex to handle optional quotes
          sed -i -E "s|repoURL: *['\"]?https://github.com/.*|repoURL: file:///target-branch|g" pull-request/rendered-apps.yaml
          sed -i -E "s|path: *['\"]?prod/|path: hydrated/|g" pull-request/rendered-apps.yaml
          sed -i -E "s|targetRevision: *['\"]?hydrated['\"]?|targetRevision: HEAD|g" pull-request/rendered-apps.yaml

          echo "Patched ApplicationSets:"
          cat pull-request/rendered-apps.yaml
          echo "::endgroup::"

      - name: Generate Diff
        run: |
          # Use enable-helm to support our kustomize setup
          export KUSTOMIZE_BUILD_OPTIONS="--enable-helm"

          docker run \
            --network=host \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd)/main:/base-branch \
            -v $(pwd)/pull-request:/target-branch \
            -v $(pwd)/output:/output \
            -e TARGET_BRANCH=refs/pull/${{ github.event.number }}/merge \
            -e REPO=${{ github.repository }} \
            -e KUSTOMIZE_BUILD_OPTIONS="$KUSTOMIZE_BUILD_OPTIONS" \
            -e TIMEOUT=300 \
            -e DEBUG=true \
            -e GIT_CONFIG_COUNT=1 \
            -e GIT_CONFIG_KEY_0=safe.directory \
            -e GIT_CONFIG_VALUE_0=* \
            dagandersen/argocd-diff-preview:v0.1.25

      - name: Post diff as comment
        run: |
          # If output/diff.md exists, post it. The image might fail if diff fails generation?
          # The tool guarantees output/diff.md usually.
          if [ -f output/diff.md ]; then
            gh pr comment ${{ github.event.number }} --repo ${{ github.repository }} --body-file output/diff.md --edit-last || \
            gh pr comment ${{ github.event.number }} --repo ${{ github.repository }} --body-file output/diff.md
          else
            echo "::warning::No diff.md generated."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
