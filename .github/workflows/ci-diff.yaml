name: "CI: ArgoCD Diff Preview"

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write

jobs:
  diff:
    name: Generate Diff
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6
        with:
          path: pull-request

      - name: Checkout base branch
        uses: actions/checkout@v6
        with:
          ref: hydrated
          path: main

      - name: Install CLI Tools
        uses: alexellis/arkade-get@master
        with:
          kustomize: v5.8.1

      - name: Render ApplicationSets (PR)
        shell: bash
        run: |
          echo "Rendering PR Branch ApplicationSets..."
          # Target 'overlays/prod' as it contains the Kustomization and env replacement logic
          kustomize build --enable-helm pull-request/kubernetes/bootstrap/gitops-controller/overlays/prod > pull-request/rendered-apps.yaml
          # PATCH: Point targetRevision to PR SHA instead of 'hydrated' to diff SOURCE changes
          sed -i "s/targetRevision: hydrated/targetRevision: ${{ github.event.pull_request.head.sha }}/g" pull-request/rendered-apps.yaml

      - name: Generate Diff
        run: |
          # Use enable-helm to support our kustomize setup
          export KUSTOMIZE_BUILD_OPTIONS="--enable-helm"

          docker run \
            --network=host \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd)/main:/base-branch \
            -v $(pwd)/pull-request:/target-branch \
            -v $(pwd)/output:/output \
            -e TARGET_BRANCH=refs/pull/${{ github.event.number }}/merge \
            -e REPO=${{ github.repository }} \
            -e KUSTOMIZE_BUILD_OPTIONS="$KUSTOMIZE_BUILD_OPTIONS" \
            -e TIMEOUT=300 \
            -e DEBUG=true \
            dagandersen/argocd-diff-preview:v0.1.25

      - name: Post diff as comment
        run: |
          # If output/diff.md exists, post it. The image might fail if diff fails generation?
          # The tool guarantees output/diff.md usually.
          if [ -f output/diff.md ]; then
            gh pr comment ${{ github.event.number }} --repo ${{ github.repository }} --body-file output/diff.md --edit-last || \
            gh pr comment ${{ github.event.number }} --repo ${{ github.repository }} --body-file output/diff.md
          else
            echo "::warning::No diff.md generated."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
