name: "CI: Validate Manifests & Images"

on:
  pull_request:
    branches: [ main ]

jobs:
  detect-overlays:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changed overlay directories
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          # Base und PR Head diffen
          git fetch origin "${{ github.base_ref }}" --depth=1 || true
          CHANGED="$(git diff --name-only "origin/${{ github.base_ref }}"...HEAD)"

          echo "Changed files:"
          echo "$CHANGED"

          # Find overlays containing kustomization.yaml from changed files
          OVERLAY_DIRS="$(echo "$CHANGED" \
            | awk -F/ '
              /kustomization\\.ya?ml$/ { print; next }
              { print }
            ' \
            | while read -r f; do
                d="$(dirname "$f")"
                while [ "$d" != "." ] && [ "$d" != "/" ]; do
                  if [ -f "$d/kustomization.yaml" ] || [ -f "$d/kustomization.yml" ]; then
                    echo "$d"
                    break
                  fi
                  d="$(dirname "$d")"
                done
              done \
            | sort -u)"

          if [ -z "$OVERLAY_DIRS" ]; then
            echo "No overlays detected from changed files. Falling back to all overlays..."
            OVERLAY_DIRS="$(find kubernetes -name kustomization.yaml -o -name kustomization.yml \
              | xargs -n1 dirname | sort -u)"
          fi

          echo "Overlays to render:"
          echo "$OVERLAY_DIRS"

          # JSON Array fÃ¼r Matrix bauen (with jq for better readability and syntax highlighting)
          JSON=$(echo "$OVERLAY_DIRS" | jq -R -s -c 'split("\n") | map(select(length > 0)) | {overlay: .}')
          echo "matrix=$JSON" >> "$GITHUB_OUTPUT"

  validate:
    runs-on: ubuntu-latest
    needs: detect-overlays
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-overlays.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install CLI Tools
        uses: alexellis/arkade-get@master
        with:
          kustomize: v5.8.1
          helm: v3.14.0
          kubeconform: v0.6.4
          crane: v0.19.0

      - name: Login to DHI
        run: crane auth login dhi.io -u "${{ secrets.DHI_USER }}" -p "${{ secrets.DHI_PASS }}"

      - name: Render Overlay
        id: render
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Render ${{ matrix.overlay }}"
          mkdir -p rendered
          kustomize build --enable-helm "${{ matrix.overlay }}" > rendered/manifests.yaml
          echo "::endgroup::"

      - name: Validate Schema (kubeconform)
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Kubeconform"
          # -ignore-missing-schemas: Ignore CRDs where no public schema exists
          kubeconform -strict -summary -ignore-missing-schemas rendered/manifests.yaml
          echo "::endgroup::"

      - name: Validate Images (crane)
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Check Images"

          # Extract images using grep/awk (Simple & Robust)
          # Matches 'image: <value>' allowing whitespace
          grep -r "^[[:space:]]*image:" rendered/manifests.yaml | awk '{print $2}' | sort -u > images.txt

          if [ ! -s images.txt ]; then
            echo "No images found to check."
            exit 0
          fi

          cat images.txt

          while read -r image; do
            # Skip empty lines
            if [ -z "$image" ]; then continue; fi

            # Normalize docker.io library images (e.g. docker.io/traefik -> docker.io/library/traefik)
            if [[ "$image" == "docker.io/"* ]] && [[ "$image" != *"/"*"/"* ]]; then
                 image="${image/docker.io\//docker.io\/library\/}"
            fi

            echo "Checking $image..."
            if ! crane digest "$image" > /dev/null; then
              echo "::error::Image $image not found or not accessible!"
              exit 1
            fi
          done < images.txt
          echo "::endgroup::"
