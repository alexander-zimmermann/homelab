name: "CI: Commit Validation"

on:
  pull_request:
    branches:
      - main

jobs:
  # 1. Path Filter to determine which validation stages to run
  changes:
    name: "Plan: Validation Stages"
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      k8s: ${{ steps.filter.outputs.k8s }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infra:
              - 'infrastructure/**'
              - '.github/workflows/ci-validate.yaml'
            k8s:
              - 'kubernetes/**'
              - '.github/workflows/ci-validate.yaml'

  # 2. Standard Contribution Checks (runs always)
  pre-commit:
    name: "Check: General Commit Integrity"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.11.4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1
        with:
          extra_args: --all-files

  # 3. Infrastructure Integrity (OpenTofu)
  tofu-validate:
    name: "Check: Infrastructure Integrity"
    needs: changes
    if: needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infrastructure
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.11.4

      - name: OpenTofu Format Check
        run: tofu fmt -check -recursive

      - name: OpenTofu Init
        run: tofu init -backend=false

      - name: OpenTofu Validate
        run: tofu validate

  # 4. Identify which K8s Workload has been modified
  resolve-workload:
    name: "Plan: K8s Workload Integrity"
    needs: changes
    if: needs.changes.outputs.k8s == 'true'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changed applications
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}" --depth=1 || true
          CHANGED="$(git diff --name-only "origin/${{ github.base_ref }}"...HEAD)"

          OVERLAY_DIRS=""
          APP_ROOTS=$(echo "$CHANGED" | grep -E '^kubernetes/(applications|components|bootstrap)/[^/]+' | awk -F/ '{print $1"/"$2"/"$3}' | sort -u)

          if [ -z "$APP_ROOTS" ]; then
             echo "No app changes detected."
          else
             read -r -a apps <<< "$APP_ROOTS"
             for app in "${apps[@]}"; do
               if [ -f "$app/overlays/dev/kustomization.yaml" ]; then
                 OVERLAY_DIRS="$OVERLAY_DIRS $app/overlays/dev"
               fi
               if [ -f "$app/overlays/prod/kustomization.yaml" ]; then
                 OVERLAY_DIRS="$OVERLAY_DIRS $app/overlays/prod"
               fi
             done
          fi

          if [ -z "$OVERLAY_DIRS" ]; then
             OVERLAY_DIRS=$(find kubernetes/applications kubernetes/components -path "*/overlays/dev" -o -path "*/overlays/prod" | sort -u)
          fi

          OVERLAY_DIRS=$(echo "$OVERLAY_DIRS" | tr ' ' '\n' | sort -u)
          JSON=$(echo "$OVERLAY_DIRS" | jq -R -s -c 'split("\n") | map(select(length > 0)) | {overlay: .}')
          echo "matrix=$JSON" >> "$GITHUB_OUTPUT"

  # 5. Validate affected K8s Workload
  validate-workload:
    name: "Check: K8s Workload Integrity"
    needs: resolve-workload
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.resolve-workload.outputs.matrix) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install CLI Tools
        uses: alexellis/arkade-get@master
        with:
          kustomize: v5.8.1
          helm: v3.14.0
          kubeconform: v0.6.4
          crane: v0.19.0
          kyverno: v1.13.3

      - name: Login to DHI
        run: crane auth login dhi.io -u "${{ secrets.DHI_USER }}" -p "${{ secrets.DHI_PASS }}"

      - name: Render Overlay (kustomize)
        run: |
          mkdir -p rendered
          kustomize build --enable-helm "${{ matrix.overlay }}" > rendered/manifests.yaml

      - name: Validate Schema (kubeconform)
        run: kubeconform -strict -summary -ignore-missing-schemas rendered/manifests.yaml

      - name: Validate Policies (kyverno)
        run: |
          POLICIES=$(grep -lR "apiVersion: kyverno.io/" kubernetes | grep -v "kustomization.yaml" | sort -u || true)
          if [ -n "$POLICIES" ]; then
             kyverno apply "$POLICIES" --resource rendered/manifests.yaml
          fi

      - name: Validate Images (crane)
        run: |
          grep -r "^[[:space:]]*image:" rendered/manifests.yaml | awk '{print $2}' | sort -u > images.txt
          while read -r image; do
            if [ -z "$image" ]; then continue; fi
            if [[ "$image" == "docker.io/"* ]] && [[ "$image" != *"/"*"/"* ]]; then
                 image="${image/docker.io\//docker.io\/library\/}"
            fi
            crane digest "$image" > /dev/null
          done < images.txt

  # 5. Final Gate: Single required check for Branch Protection
  ci-status:
    name: "Quality Gate"
    if: always()
    needs:
      - pre-commit
      - tofu-validate
      - validate-workload
    runs-on: ubuntu-latest
    steps:
      - name: Check Status
        if: |
          contains(needs.*.result, 'failure') ||
          contains(needs.*.result, 'cancelled')
        run: |
          echo "::error::Validation suite failed or was cancelled."
          exit 1
      - name: All checks passed
        run: echo "Validation complete."
