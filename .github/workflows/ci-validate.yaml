name: "CI: Validate Manifests & Images"

on:
  pull_request:
    branches: [ main ]

jobs:
  detect-overlays:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Detect changed applications
        id: set-matrix
        shell: bash
        run: |
          set -euo pipefail

          # Fetch main to diff against
          git fetch origin "${{ github.base_ref }}" --depth=1 || true
          CHANGED="$(git diff --name-only "origin/${{ github.base_ref }}"...HEAD)"

          echo "Changed files:"
          echo "$CHANGED"

          OVERLAY_DIRS=""

          # Extract unique App Roots (dir logic: kubernetes/{applications,components,bootstrap}/<app>)
          APP_ROOTS=$(echo "$CHANGED" | grep -E '^kubernetes/(applications|components|bootstrap)/[^/]+' | awk -F/ '{print $1"/"$2"/"$3}' | sort -u)

          # For each App Root, check if overlays/dev or overlays/prod exist.
          if [ -z "$APP_ROOTS" ]; then
             echo "No app changes detected."
          else
             for app in $APP_ROOTS; do
               if [ -f "$app/overlays/dev/kustomization.yaml" ]; then
                 OVERLAY_DIRS="$OVERLAY_DIRS $app/overlays/dev"
               fi
               if [ -f "$app/overlays/prod/kustomization.yaml" ]; then
                 OVERLAY_DIRS="$OVERLAY_DIRS $app/overlays/prod"
               fi
             done
          fi

          # Fallback: If no overlays found (e.g. only irrelevant file changed?), fallback to all.
          if [ -z "$OVERLAY_DIRS" ]; then
             echo "No specific overlays identified. Falling back to ALL dev/prod overlays..."
             # Find all dev/prod overlays
             OVERLAY_DIRS=$(find kubernetes/applications kubernetes/components -path "*/overlays/dev" -o -path "*/overlays/prod" | sort -u)
          fi

          # Trim leading space and format for JSON
          OVERLAY_DIRS=$(echo $OVERLAY_DIRS | tr ' ' '\n' | sort -u)

          echo "Overlays to validate:"
          echo "$OVERLAY_DIRS"

          JSON=$(echo "$OVERLAY_DIRS" | jq -R -s -c 'split("\n") | map(select(length > 0)) | {overlay: .}')
          echo "matrix=$JSON" >> "$GITHUB_OUTPUT"

  validate:
    runs-on: ubuntu-latest
    needs: detect-overlays
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-overlays.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install CLI Tools
        uses: alexellis/arkade-get@master
        with:
          kustomize: v5.8.1
          helm: v3.14.0
          kubeconform: v0.6.4
          crane: v0.19.0
          kyverno: v1.13.3

      - name: Login to DHI
        run: crane auth login dhi.io -u "${{ secrets.DHI_USER }}" -p "${{ secrets.DHI_PASS }}"

      - name: Render Overlay (kustomize)
        id: render
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Render ${{ matrix.overlay }}"
          mkdir -p rendered
          kustomize build --enable-helm "${{ matrix.overlay }}" > rendered/manifests.yaml
          echo "::endgroup::"

      - name: Validate Schema (kubeconform)
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Kubeconform"
          kubeconform -strict -summary -ignore-missing-schemas rendered/manifests.yaml
          echo "::endgroup::"

      - name: Validate Policies (kyverno)
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Kyverno Policy Check/Apply"

          # Find Policy Files. We look for files containing "apiVersion: kyverno.io/"
          POLICIES=$(grep -lR "apiVersion: kyverno.io/" kubernetes | grep -v "kustomization.yaml" | sort -u || true)

          if [ -z "$POLICIES" ]; then
             echo "No Kyverno policies found in 'kubernetes/'."
             echo "Skipping policy validation."
             exit 0
          fi

          echo "Found the following policy files:"
          echo "$POLICIES"

          # Apply Policies. We use the previously rendered 'rendered/manifests.yaml'
          echo "Running kyverno apply..."
          kyverno apply $POLICIES --resource rendered/manifests.yaml
          echo "::endgroup::"

      - name: Validate Images (crane)
        shell: bash
        run: |
          set -euo pipefail
          echo "::group::Check Images"
          grep -r "^[[:space:]]*image:" rendered/manifests.yaml | awk '{print $2}' | sort -u > images.txt

          if [ ! -s images.txt ]; then
            echo "No images found to check."
            exit 0
          fi

          while read -r image; do
            if [ -z "$image" ]; then continue; fi

            # Normalize docker.io library images
            if [[ "$image" == "docker.io/"* ]] && [[ "$image" != *"/"*"/"* ]]; then
                 image="${image/docker.io\//docker.io\/library\/}"
            fi

            echo "Checking $image..."
            if ! crane digest "$image" > /dev/null; then
              echo "::error::Image $image not found or not accessible!"
              exit 1
            fi
          done < images.txt
          echo "::endgroup::"
