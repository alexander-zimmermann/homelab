name: "CI: Validate Manifests Changes"

on:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  validate-kustomize:
    name: Validate Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install CLI Tools
        uses: alexellis/arkade-get@master
        with:
          kustomize: v5.8.1

      - name: Validate All Overlays
        run: |
          set -euo pipefail
          # Find all kustomization.yaml files in overlays (prod/dev)
          OVERLAYS=$(find kubernetes -type f -name "kustomization.yaml" | grep "overlays/")

          for kfile in $OVERLAYS; do
            dir=$(dirname "$kfile")
            echo "::group::Validating $dir"
            kustomize build --enable-helm "$dir" > /dev/null
            echo "âœ… $dir builds successfully."
            echo "::endgroup::"
          done

  extract-images:
    name: Extract OCI Images
    needs: validate-kustomize
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup ORAS CLI
        uses: oras-project/setup-oras@v1

      - name: Extract Images
        id: extract
        run: |
          # Use the helper script to get all images
          ./.github/scripts/ci-extract-images.sh kubernetes images.json
          echo "matrix=$(jq -c '{image: .}' images.json)" >> $GITHUB_OUTPUT

    outputs:
      matrix: ${{ steps.extract.outputs.matrix }}

  check-images:
    name: Verify ${{ matrix.image }}
    needs: extract-images
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.extract-images.outputs.matrix) }}
    steps:
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Image Existence
        run: |
          # Use oras to check if the manifest exists without pulling
          if [[ "${{ matrix.image }}" == dhi.io/* ]]; then
            # Requires DHI credentials if private
            echo "Skipping private DHI check for now or implement login"
            exit 0
          fi

          echo "Checking ${{ matrix.image }}..."
          oras manifest fetch ${{ matrix.image }} > /dev/null
