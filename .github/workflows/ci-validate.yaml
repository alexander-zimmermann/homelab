name: "CI: Validate Manifests Changes"

on:
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  validate-kustomize:
    name: Validate Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install CLI Tools
        uses: alexellis/arkade-get@master
        with:
          kustomize: v5.8.1

      - name: Validate All Overlays
        run: |
          set -euo pipefail
          # Find all kustomization.yaml files in overlays (prod/dev)
          OVERLAYS=$(find kubernetes -type f -name "kustomization.yaml" | grep "overlays/")

          for kfile in $OVERLAYS; do
            dir=$(dirname "$kfile")
            echo "::group::Validating $dir"
            kustomize build --enable-helm "$dir" > /dev/null
            echo "âœ… $dir builds successfully."
            echo "::endgroup::"
          done

  extract-images:
    name: Extract Images
    needs: validate-kustomize
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.extract.outputs.matrix }}
      images: ${{ steps.extract.outputs.images }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup ORAS CLI
        uses: oras-project/setup-oras@v1

      - name: Install Python Dependencies
        run: pip install pyyaml

      - name: Extract Images
        id: extract
        run: |
          ./.github/scripts/ci-extract-images.py . images.json
          echo "matrix=$(jq -nc '{include: [range(8) | {shard: .}]}')" >> $GITHUB_OUTPUT
          echo "images=$(cat images.json)" >> $GITHUB_OUTPUT

  check-images:
    name: Verify Images
    needs: extract-images
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.extract-images.outputs.matrix).include }}
    steps:
      - name: Setup ORAS CLI
        uses: oras-project/setup-oras@v1

      - name: Validate Images
        env:
            IMAGES: ${{ needs.extract-images.outputs.images }}
            SHARD: ${{ matrix.shard }}
        run: |
            # Filter images for this shard using jq
            # We use to_entries to get indices, select based on modulo, and map back to values
            echo "$IMAGES" | jq -r --argjson shard "$SHARD" --argjson total 8 \
                'to_entries | map(select(.key % $total == $shard)) | map(.value) | .[]' | while read -r image; do

                if [[ "$image" == dhi.io/* ]]; then
                    echo "Skipping private DHI check for $image"
                    continue
                fi

                echo "Checking $image..."
                if ! oras manifest fetch "$image" > /dev/null; then
                    echo "::error::Image $image not found!"
                    exit 1
                fi
            done
