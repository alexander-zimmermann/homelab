name: Mirror DHI OCI Helm charts

on:
  schedule: [{ cron: "00 2 * * *" }]
  workflow_dispatch:

env:
  OWNER: ${{ github.repository_owner }}

jobs:
  discover:
    name: Discover missing tags per chart
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      matrix: ${{ steps.make-matrix.outputs.matrix }}
    steps:
      - name: Install ORAS CLI
        uses: oras-project/setup-oras@v1

      - name: Login dhi.io
        run: oras login dhi.io -u "${{ secrets.DHI_USER }}" -p "${{ secrets.DHI_PASS }}"

      - name: Login ghcr.io
        run: echo "${{ github.token }}" | oras login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

      - name: "Preflight: Assert GHCR namespace is publishable"
        shell: bash
        run: |
          set -euo pipefail
          export LC_ALL=C

          if [ "${OWNER}" != "${{ github.repository_owner }}" ] && [ -z "${{ secrets.GHCR_PAT }}" ]; then
            echo "::error::To publish to ghcr.io/${OWNER}, provide a GHCR_PAT secret with write:packages and log in with it."
            exit 1
          fi
          echo "✅ GHCR namespace is publishable."

      - name: "Preflight: Verify DHI connectivity"
        run: |
          set -euo pipefail
          export LC_ALL=C

          if ! oras repo tags dhi.io/redis-chart | head -n 1 > /dev/null; then
            echo "::error::Failed to list tags from dhi.io. Check DHI_USER/DHI_PASS permissions."
            exit 1
          fi
          echo "✅ DHI connectivity verified."

      - id: make-matrix
        name: Build JSON matrix of (src,dst,tag) to copy
        shell: bash
        run: |
          set -euo pipefail
          export LC_ALL=C

          # Source repositories (1:1 mapping to destination path)
          SRC_REPOS=(
            "dhi.io/redis-chart"
            "dhi.io/sealed-secrets-chart"
            "dhi.io/cert-manager-chart"
            "dhi.io/metrics-server-chart"
            "dhi.io/external-dns-chart"
          )

          # Destination path prefix in GHCR
          DST_PREFIX="ghcr.io/${OWNER}/charts"

          # Helper: normalize & sort (trim whitespace, drop empty lines, unique)
          norm() { sed 's/^\s*//; s/\s*$//' | sed '/^$/d' | sort -u; }

          TMP_DIR="$(mktemp -d)"
          ITEMS_JSON="[]"

          for SRC in "${SRC_REPOS[@]}"; do
            NAME="$(basename "$SRC")"
            DST="${DST_PREFIX}/${NAME}"

            # Query tags; surface any source errors clearly
            if ! SRC_TAGS="$(oras repo tags "$SRC" 2>/tmp/src.err)"; then
              echo "::error::Failed to read source tags for $SRC: $(cat /tmp/src.err)"
              exit 1
            fi

            # Destination tag listing may fail if package doesn't exist yet → tolerate
            DST_TAGS="$(oras repo tags "$DST" 2>/tmp/dst.err || true)"

            printf "%s\n" "$SRC_TAGS" | norm > "${TMP_DIR}/src.txt"
            printf "%s\n" "$DST_TAGS" | norm > "${TMP_DIR}/dst.txt"

            # Compute missing tags (present in source, absent in destination)
            comm -23 "${TMP_DIR}/src.txt" "${TMP_DIR}/dst.txt" > "${TMP_DIR}/to_copy.txt" || true

            # Build the copy plan as a JSON array of objects
            if [ -s "${TMP_DIR}/to_copy.txt" ]; then
              while read -r TAG; do
                ITEMS_JSON=$(jq -c \
                  --arg src "$SRC" \
                  --arg dst "$DST" \
                  --arg tag "$TAG" \
                  '. + [{src:$src, dst:$dst, tag:$tag}]' \
                  <<< "${ITEMS_JSON}")
              done < "${TMP_DIR}/to_copy.txt"
            fi
          done

          # Expose matrix for the next job (GitHub Actions matrix format)
          echo "matrix=$(jq -c '{include: .}' <<< "${ITEMS_JSON}")" >> "$GITHUB_OUTPUT"

  mirror:
    name: Copy missing tags (max 3 in parallel)
    needs: discover
    if: ${{ fromJson(needs.discover.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - name: Install ORAS CLI
        uses: oras-project/setup-oras@v1

      - name: Login dhi.io
        run: oras login dhi.io -u "${{ secrets.DHI_USER }}" -p "${{ secrets.DHI_PASS }}"

      - name: Login ghcr.io
        run: echo "${{ github.token }}" | oras login ghcr.io -u "${{ github.repository_owner }}" --password-stdin

      - name: Copy ${{ matrix.tag }} from ${{ matrix.src }} → ${{ matrix.dst }}
        shell: bash
        run: |
          set -euo pipefail
          # '-r': also copy referrers (e.g., signatures/SBOM attestations) if present
          oras cp -r "${{ matrix.src }}:${{ matrix.tag }}" "${{ matrix.dst }}:${{ matrix.tag }}"
