---
version: "3"

vars:
  PYTHON: "{{.TASKFILE_DIR}}/.venv/bin/python"
  PIP: "{{.TASKFILE_DIR}}/.venv/bin/pip"
  TIMEOUT_CILIUM: "300s"
  TIMEOUT_ARGOCD: "300s"
  # Colors
  BLUE: '\033[0;34m'
  GREEN: '\033[0;32m'
  YELLOW: '\033[0;33m'
  RED: '\033[0;31m'
  RESET: '\033[0m'

tasks:
  default:
    cmds:
      - task --list

  initialize:
    desc: "Initialize homelab project on macOS (Homebrew, virtualenv, base Python deps)"
    cmds:
      - cmd: printf "{{.BLUE}}üöÄ Initializing homelab environment...{{.RESET}}\n"
        silent: true
      - for:
          var: FORMULAS
          as: FORMULA
        cmd: "brew list {{.FORMULA}} >/dev/null 2>&1 || brew install {{.FORMULA}} >/dev/null 2>&1"
      - test -d .venv || python3 -m venv .venv
      - "{{.PIP}} install --upgrade pip >/dev/null 2>&1"
      - for:
          var: PACKAGES
          as: PACKAGE
        cmd: "{{.PIP}} install {{.PACKAGE}} >/dev/null 2>&1"
      - pre-commit install >/dev/null 2>&1
      - cmd: printf "{{.GREEN}}‚úÖ Initialization complete!{{.RESET}}\n"
        silent: true
    preconditions:
      - sh: command -v brew
        msg: |
          Homebrew is not installed. Please install Homebrew using the following command:
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      - sh: command -v python3
        msg: |
          Python3 is not installed. Please install Python3 using Homebrew:
          brew install python3
    vars:
      FORMULAS: >-
        kubernetes-cli
        kustomize
        helm
        opentofu
        talosctl
        cilium-cli
        argocd
      PACKAGES: >-
        pyyaml
        jsonschema
        jinja2
        pre-commit

  infra:prepare:
    desc: "Prepare Terraform/OpenTofu environment and generate configuration"
    dir: infrastructure
    env:
      PATH: "{{.TASKFILE_DIR}}/.venv/bin:{{.PATH}}"
      PYTHONPATH: scripts
    sources:
      - infrastructure-manifest.yaml
      - schemas/infrastructure-manifest.schema.json
      - templates/*.j2
      - scripts/generate_checksums.py
      - scripts/generate_tfvars.py
      - scripts/validate_infrastructure.py
    generates:
      - generated.auto.tfvars
      - build/checksums.yaml
    preconditions:
      - sh: test -x ../.venv/bin/python
        msg: "Python virtual environment missing or not executable. Run 'task initialize' first."
    cmds:
      - cmd: printf "{{.BLUE}}üèóÔ∏è  Preparing OpenTofu environment...{{.RESET}}\n"
        silent: true
      # Phase 1: Pre-validation (fail-fast)
      - "{{.PYTHON}} scripts/validate_infrastructure.py{{if .CLI_ARGS}} {{.CLI_ARGS}}{{end}} pre"
      # Phase 2: Build directory setup
      - mkdir -p build
      - 'test -f build/checksums.yaml || echo "checksums: {}" > build/checksums.yaml'
      # Phase 3: Generation tfvars
      - "{{.PYTHON}} scripts/generate_tfvars.py"
      # Phase 4: Checksum update
      - "{{.PYTHON}} scripts/generate_checksums.py{{if .CLI_ARGS}} {{.CLI_ARGS}}{{end}}"
      - "{{.PYTHON}} scripts/generate_tfvars.py {{if .CLI_ARGS}} {{.CLI_ARGS}}{{end}}"
      # Phase 5: Post-validation (consistency)
      - "{{.PYTHON}} scripts/validate_infrastructure.py{{if .CLI_ARGS}} {{.CLI_ARGS}}{{end}} post"
      # Phase 6: Initialization of OpenTofu working directory
      - tofu init
      - cmd: printf "{{.GREEN}}‚úÖ OpenTofu prepared!{{.RESET}}\n"
        silent: true

  infra:plan:
    desc: "Generate plan for infrastructure deployment"
    dir: infrastructure
    deps: [infra:prepare]
    preconditions:
      - sh: test -f generated.auto.tfvars
        msg: "generated.auto.tfvars is missing ‚Äì run 'task infra:prepare' first."
    cmds:
      - cmd: printf "{{.BLUE}}üïµÔ∏è  Generating infrastructure plan...{{.RESET}}\n"
        silent: true
      - tofu plan -out tfplan
      - cmd: printf "{{.GREEN}}‚úÖ Plan generated (tfplan){{.RESET}}\n"
        silent: true

  infra:apply:
    desc: "Apply planned infrastructure changes to Proxmox (OpenTofu apply)"
    dir: infrastructure
    deps: [infra:plan]
    preconditions:
      - sh: test -f tfplan
        msg: "tfplan is missing ‚Äì run 'task infra:plan' first."
    cmds:
      - cmd: printf "{{.BLUE}}üöÄ Applying infrastructure changes...{{.RESET}}\n"
        silent: true
      - tofu apply tfplan
      - cmd: printf "{{.GREEN}}‚úÖ Infrastructure applied!{{.RESET}}\n"
        silent: true

  infra:refresh:
    desc: "Refresh infrastructure state (OpenTofu refresh)"
    dir: infrastructure
    cmds:
      - cmd: printf "{{.BLUE}}üîÑ Refreshing infrastructure state...{{.RESET}}\n"
        silent: true
      - tofu refresh
      - cmd: printf "{{.GREEN}}‚úÖ Infrastructure state refreshed!{{.RESET}}\n"
        silent: true

  infra:destroy:
    desc: "Destroy (tear down) all managed Proxmox infrastructure"
    dir: infrastructure
    cmds:
      - cmd: printf "{{.RED}}üí• Destroying infrastructure...{{.RESET}}\n"
        silent: true
      - tofu destroy -auto-approve
      - cmd: printf "{{.GREEN}}‚úÖ Infrastructure destroyed.{{.RESET}}\n"
        silent: true

  cluster:bootstrap:
    desc: "Bootstrap ArgoCD on the Kubernetes cluster (usage: task cluster:bootstrap ENV=dev|prod)"
    vars:
      ENV: '{{.ENV | default "dev"}}'
    preconditions:
      - sh: command -v kubectl
        msg: "kubectl is not installed"
    cmds:
      - cmd: printf "{{.BLUE}}‚è≥ Waiting for Kubernetes API...{{.RESET}}\n"
        silent: true
      - until kubectl get --raw /healthz >/dev/null 2>&1; sleep 5; done
      - cmd: printf "{{.GREEN}}‚úÖ API is ready!{{.RESET}}\n"
        silent: true
      - cmd: printf "{{.BLUE}}üåê Installing Cilium + ArgoCD ({{.ENV}})...{{.RESET}}\n"
        silent: true
      - kubectl apply -k k8s-cluster/bootstrap/overlays/{{.ENV}}
      - cmd: printf "{{.BLUE}}‚è≥ Waiting for Cilium...{{.RESET}}\n"
        silent: true
      - kubectl -n kube-system wait --for=condition=ready pod -l app.kubernetes.io/name=cilium --timeout={{.TIMEOUT_CILIUM}}
      - cmd: printf "{{.GREEN}}‚úÖ Cilium is ready!{{.RESET}}\n"
        silent: true
      - cmd: printf "{{.BLUE}}‚è≥ Waiting for ArgoCD...{{.RESET}}\n"
        silent: true
      - kubectl -n gitops-controller wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server --timeout={{.TIMEOUT_ARGOCD}}
      - cmd: printf "{{.GREEN}}‚úÖ ArgoCD is ready!{{.RESET}}\n"
        silent: true
      - cmd: printf "{{.BLUE}}üåê Installing Sealed Secrets...{{.RESET}}\n"
        silent: true
      - kubectl apply -f k8s-cluster/secrets/sealed-secrets-key.yaml
      - echo "ArgoCD admin password is $(kubectl get secret/argocd-initial-admin-secret -n gitops-controller -o jsonpath='{.data.password}' | base64 -d ; echo)"
      - task: cluster:verify

  cluster:verify:
    desc: "Verify cluster health"
    preconditions:
      - sh: command -v kubectl
        msg: "kubectl is not installed"
    cmds:
      - cmd: printf "{{.BLUE}}üîç Verifying cluster health...{{.RESET}}\n"
        silent: true
      - kubectl get nodes
      - kubectl get pods -A
      - kubectl -n kube-system exec ds/cilium -- cilium status
      - cmd: printf "{{.BLUE}}üíæ Verifying Storage...{{.RESET}}\n"
        silent: true
      - kubectl get storageclass
      - cmd: printf "{{.BLUE}}ü§ñ Verifying ArgoCD Applications...{{.RESET}}\n"
        silent: true
      - kubectl -n gitops-controller get applications
      - cmd: printf "{{.GREEN}}‚úÖ Cluster verification complete!{{.RESET}}\n"
        silent: true
