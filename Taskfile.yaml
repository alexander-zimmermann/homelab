---
version: "3"

vars:
  PYTHON: "{{.ROOT_DIR}}/.venv/bin/python"
  PIP: "{{.ROOT_DIR}}/.venv/bin/pip"

includes:
  infra:
    taskfile: ./tasks/infrastructure.yaml
    dir: ./infrastructure
  k8s:
    taskfile: ./tasks/kubernetes.yaml
  cluster:
    taskfile: ./tasks/cluster.yaml

tasks:
  default:
    cmds:
      - cmd: task --list
        silent: true

  initialize:
    desc: "initialize homelab project environment"
    summary: |
      Setup project dependencies and environment.
      - Installs Homebrew packages (k8s-cli, tofu, omnictl, etc)
      - Sets up Python virtualenv (.venv)
      - Installs Python requirements (kustomize, pylint)
      - Configures pre-commit hooks
    vars:
      FORMULAS: >-
        kubernetes-cli
        kustomize
        helm
        argocd
        opentofu
        cilium-cli
        siderolabs/tap/sidero-tools
      PACKAGES: >-
        pre-commit
    preconditions:
      - sh: command -v brew
        msg: |
          Homebrew is not installed. Please install Homebrew using the following command:
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      - sh: command -v python3
        msg: |
          Python3 is not installed. Please install Python3 using Homebrew:
          brew install python3
    cmds:
      # Phase 1: Install System Packages
      - for:
          var: FORMULAS
          as: FORMULA
        cmd: "brew list {{.FORMULA}} >/dev/null 2>&1 || brew install {{.FORMULA}} >/dev/null 2>&1"

      # Phase 2: Setup Python Environment
      - test -d .venv || python3 -m venv .venv
      - "{{.PIP}} install --upgrade pip >/dev/null 2>&1"

      # Phase 3: Install Python Dependencies
      - for:
          var: PACKAGES
          as: PACKAGE
        cmd: "{{.PIP}} install {{.PACKAGE}} >/dev/null 2>&1"
      - "{{.TASKFILE_DIR}}/.venv/bin/pre-commit install >/dev/null 2>&1"
