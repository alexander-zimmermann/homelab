---
version: "3"

vars:
  PYTHON: "{{.ROOT_DIR}}/.venv/bin/python"
  PIP: "{{.ROOT_DIR}}/.venv/bin/pip"

  BLUE: '\033[0;34m'
  GREEN: '\033[0;32m'
  YELLOW: '\033[0;33m'
  RED: '\033[0;31m'
  RESET: '\033[0m'

includes:
  infra:
    taskfile: ./tasks/infrastructure.yaml
    dir: ./infrastructure
  k8s:
    taskfile: ./tasks/kubernetes.yaml
    dir: ./kubernetes
  cluster:
    taskfile: ./tasks/cluster-mgmt.yaml
    dir: ./cluster-mgmt

tasks:
  default:
    cmds:
      - cmd: task --list
        silent: true

  initialize:
    desc: "Initialize project environment (Homebrew, Python)"
    vars:
      FORMULAS: >-
        kubernetes-cli
        kustomize
        helm
        opentofu
        talosctl
        siderolabs/tap/sidero-tools
        cilium-cli
        argocd
        int128/kubelogin/kubelogin
      PACKAGES: >-
        pre-commit
    preconditions:
      - sh: command -v brew
        msg: |
          Homebrew is not installed. Please install Homebrew using the following command:
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      - sh: command -v python3
        msg: |
          Python3 is not installed. Please install Python3 using Homebrew:
          brew install python3
    cmds:
      - cmd: printf "{{.BLUE}}ðŸš€ Initializing homelab environment...{{.RESET}}\n"
        silent: true
      # Phase 1: Install System Packages
      - for:
          var: FORMULAS
          as: FORMULA
        cmd: "brew list {{.FORMULA}} >/dev/null 2>&1 || brew install {{.FORMULA}} >/dev/null 2>&1"

      # Phase 2: Setup Python Environment
      - test -d .venv || python3 -m venv .venv
      - "{{.PIP}} install --upgrade pip >/dev/null 2>&1"

      # Phase 3: Install Python Dependencies
      - for:
          var: PACKAGES
          as: PACKAGE
        cmd: "{{.PIP}} install {{.PACKAGE}} >/dev/null 2>&1"
      - "{{.TASKFILE_DIR}}/.venv/bin/pre-commit install >/dev/null 2>&1"

      # All phases complete
      - cmd: printf "{{.GREEN}}âœ… Initialization complete!{{.RESET}}\n"
        silent: true
