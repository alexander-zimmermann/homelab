ci_vendor_config:
  std_linux:
    packages: [qemu-guest-agent, htop, vim]
    runcmd:
      - systemctl enable --now qemu-guest-agent

  cluster-mgmt:
    packages:
      - qemu-guest-agent
      - htop
      - vim
      - nfs-common
      - docker.io
      - docker-compose-v2
      - git
      - curl
      - snapd

    snap:
      commands:
        - ["install", "task", "--classic"]
        - ["install", "lego", "--classic"]

    disk_setup:
      /dev/sdb:
        table_type: gpt
        layout: true
        overwrite: false

    fs_setup:
      - label: omni_data
        filesystem: ext4
        device: /dev/sdb
        partition: auto

    mounts:
      - ["LABEL=omni_data", "/mnt/omni"]
      - [
          "storage.zimmermann.eu.com:/srv/mgmt",
          "/mnt/backup",
          "nfs",
          "defaults,_netdev,noauto,nofail,x-systemd.after=cloud-init-network.service",
          "0",
          "0",
        ]

    mount_default_fields: [None, None, "auto", "defaults", "0", "0"]

    bootcmd:
      - mkdir -p /opt/omni
      - mkdir -p /mnt/omni
      - mkdir -p /mnt/backup

    runcmd:
      ## Symlinks for snap packages
      - ["ln", "-s", "/snap/bin/lego", "/usr/local/bin/lego"]
      - ["ln", "-s", "/snap/bin/task", "/usr/local/bin/task"]
      ## Manually mount NFS share (after nfs-common install)
      - ["mount", "/mnt/backup"]
      ## Set permissions for data disk
      - ["chown", "omni:omni", "/opt/omni"]
      - ["chown", "omni:omni", "/mnt/omni"]
      ## Setup Omni
      - ["bash", "/usr/local/bin/omni-bootstrap.sh"]
      ## Systemd services
      - ["systemctl", "enable", "--now", "qemu-guest-agent"]
      - ["systemctl", "enable", "--now", "docker"]
      - ["systemctl", "enable", "--now", "omni-renew-ssl.timer"]

    write_files:
      ## Environment file for lego, Omni Bootstrap, and Omni docker compose
      - path: /opt/omni/.lego
        template_file: templates/30-cloud-init/omni.env.lego.tftpl
        secret_ref: omni_env_lego
        permissions: "0660"
        owner: "omni:omni"
        defer: true

      - path: /opt/omni/.bootstrap
        template_file: templates/30-cloud-init/omni.env.bootstrap.tftpl
        secret_ref: omni_env_bootstrap
        permissions: "0660"
        owner: "omni:omni"
        defer: true

      - path: /opt/omni/.env
        template_file: templates/30-cloud-init/omni.env.docker.tftpl
        secret_ref: omni_env_docker
        permissions: "0660"
        owner: "omni:omni"
        defer: true

      ## Systemd service for renewing SSL certificates
      - path: /etc/systemd/system/omni-renew-ssl.service
        content_file: templates/30-cloud-init/omni-renew-ssl.service

      - path: /etc/systemd/system/omni-renew-ssl.timer
        content_file: templates/30-cloud-init/omni-renew-ssl.timer

      - path: /usr/local/bin/omni-renew-ssl.sh
        content_file: templates/30-cloud-init/omni-renew-ssl.sh
        permissions: "0755"
        owner: "omni:omni"
        defer: true

      ## Omni bootstrap script
      - path: /usr/local/bin/omni-bootstrap.sh
        content_file: templates/30-cloud-init/omni-bootstrap.sh
        permissions: "0755"
        owner: "omni:omni"
        defer: true

      ## Omni Docker Compose configuration
      - path: /opt/omni/compose.yaml
        content_file: templates/30-cloud-init/omni-compose.yaml
        permissions: "0644"
        owner: "omni:omni"
        defer: true
