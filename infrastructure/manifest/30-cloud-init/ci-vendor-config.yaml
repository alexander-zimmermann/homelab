---
ci_vendor_config:
  std_linux:
    packages: [qemu-guest-agent, htop, vim]
    runcmd:
      - systemctl enable --now qemu-guest-agent

  omni:
    packages:
      - qemu-guest-agent
      - htop
      - vim
      - nfs-common
      - docker.io
      - docker-compose-v2
      - git
      - curl
      - snapd

    snap:
      commands:
        - ["install", "task", "--classic"]
        - ["install", "lego", "--classic"]

    mounts:
      - ["storage.zimmermann.eu.com:/srv/mgmt", "/mnt/mgmt", "nfs"]

    mount_default_fields:
      [
        None,
        None,
        auto,
        "defaults,_netdev,noauto,nofail,x-systemd.after=cloud-init-network.service",
        "0",
        "0",
      ]

    bootcmd:
      - mkdir -p /mnt/mgmt

    runcmd:
      # Symlinks for snap packages
      - ["ln", "-s", "/snap/bin/lego", "/usr/local/bin/lego"]
      - ["ln", "-s", "/snap/bin/task", "/usr/local/bin/task"]
      # Manually mount NFS share (after nfs-common install)
      - ["mount", "/mnt/mgmt"]
      # Setup Omni
      - ["bash", "/usr/local/bin/omni-setup-ssl.sh"]
      - ["bash", "/usr/local/bin/omni-setup-gpg.sh"]
      - ["bash", "/usr/local/bin/omni-bootstrap.sh"]
      # Systemd services
      - ["systemctl", "enable", "--now", "qemu-guest-agent"]
      - ["systemctl", "enable", "--now", "docker"]
      - ["systemctl", "enable", "--now", "omni-renew-ssl.timer"]

    write_files:
      # Secrets for lego
      - path: /etc/default/lego
        secret_ref: lego
        permissions: "0600"
        owner: "omni:omni"
        defer: true

      # SSL Certificate Setup
      - path: /usr/local/bin/omni-setup-ssl.sh
        permissions: "0755"
        template_file: templates/30-cloud-init/omni-setup-ssl.sh.tftpl
        vars:
          env_file: /etc/default/lego
          cert_path: /mnt/mgmt/certificates
          owner: "omni:omni"

      - path: /etc/systemd/system/omni-renew-ssl.service
        template_file: templates/30-cloud-init/omni-renew-ssl.service.tftpl
        vars:
          env_file: /etc/default/lego
          cert_path: /mnt/mgmt/certificates
          owner: "omni:omni"

      - path: /etc/systemd/system/omni-renew-ssl.timer
        content_file: templates/30-cloud-init/omni-renew-ssl.timer

      # Secrets for omni
      - path: /etc/default/omni
        secret_ref: omni
        permissions: "0600"
        owner: "omni:omni"
        defer: true

      # GPG Key Setup
      - path: /usr/local/bin/omni-setup-gpg.sh
        permissions: "0755"
        template_file: templates/30-cloud-init/omni.setup-gpg.sh.tftpl
        vars:
          env_file: /etc/default/omni
          keys_path: /mnt/mgmt/keys
          owner: "omni:omni"

      # Bootstrap Omni
      - path: /usr/local/bin/omni-bootstrap.sh
        permissions: "0755"
        template_file: templates/30-cloud-init/omni-bootstrap.sh.tftpl
        vars:
          env_file: /etc/default/omni
          repo_url: "https://oauth2:$${GITHUB_TOKEN}@github.com/alexander-zimmermann/homelab.git"
          repo_path: /opt/homelab
          omni_path: /opt/omni
          volume_path: /mnt/mgmt
          owner: "omni:omni"
