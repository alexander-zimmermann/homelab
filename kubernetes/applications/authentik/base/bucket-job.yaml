apiVersion: batch/v1
kind: Job

metadata:
  name: create-authentik-backup-bucket
  namespace: authentik
  annotations:
    argocd.argoproj.io/hook: PreSync
spec:
  backoffLimit: 2
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      serviceAccountName: default
      restartPolicy: OnFailure
      # wait until RustFS is reachable
      initContainers:
        - name: wait-for-rustfs
          image: curlimages/curl:8.18.0
          command: ["/bin/sh", "-c"]
          args:
            - |
              until curl -sSf http://rustfs-svc.rustfs.svc.cluster.local:9000/health >/dev/null; do
                echo "Warte auf S3 Endpoint..."
                sleep 3
              done
      # create bucket
      containers:
        - name: mc
          image: minio/mc:latest
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            readOnlyRootFilesystem: true
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -euo pipefail
              export MC_CONFIG_DIR=$(mktemp -d)
              mc alias set --debug rustfs http://rustfs-svc.rustfs.svc.cluster.local:9000 "$ACCESS_KEY" "$SECRET_KEY"
              mc mb --debug --ignore-existing rustfs/authentik-backups
          env:
            - name: ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: rustfs-creds
                  key: RUSTFS_ACCESS_KEY
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: rustfs-creds
                  key: RUSTFS_SECRET_KEY
          resources:
            requests:
              cpu: "10m"
              memory: "32Mi"
            limits:
              cpu: "200m"
              memory: "128Mi"
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
