global:
  env:
    # Database password from a Secret created by the CloudNativePG Cluster
    - name: AUTHENTIK_POSTGRESQL__PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-db-app
          key: password
    # Authentik internal secret key (signing/encryption)
    - name: AUTHENTIK_SECRET_KEY
      valueFrom:
        secretKeyRef:
          name: authentik-credentials
          key: AUTHENTIK_SECRET_KEY
    # Initial bootstrap admin password
    - name: AUTHENTIK_BOOTSTRAP_PASSWORD
      valueFrom:
        secretKeyRef:
          name: authentik-credentials
          key: AUTHENTIK_BOOTSTRAP_PASSWORD

authentik:
  # Optimization: Fewer workers and no preloading saves RAM in small setups
  env:
    - name: AUTHENTIK_WEB__WORKERS
      value: "2"
    - name: AUTHENTIK_WEB__PRELOAD
      value: "false"
    - name: AUTHENTIK_WORKER__WORKERS
      value: "2"
    - name: AUTHENTIK_WORKER__PREFETCH_MULTIPLIER
      value: "1"
    - name: AUTHENTIK_WORKER__MAX_MEMORY_PER_CHILD
      value: "300000" # ~300 MiB limit per process

  # SMTP configuration for notifications and password resets
  email:
    host: smtprelay.smtprelay.svc.cluster.local
    port: 25
    from: "Authentik <admin@zimmermann.sh>"

  # PostgreSQL connection settings (external DB via CloudNativePG)
  postgresql:
    host: "{{ .Release.Name }}-db-rw"

server:
  # Expose Authentik service via Cilium/BGP-announced LoadBalancer
  service:
    type: LoadBalancer
    labels:
      bgp.cilium.io/ip-pool: default
      bgp.cilium.io/advertise-service: default

  # Prometheus Monitoring (Opt-In)
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      labels:
        release: prometheus
