apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

replacements:
  # Inject domain name into the Certificate and IngressRoute
  - sourceValue: auth.zimmermann.phd
    targets:
      - select:
          kind: Certificate
          name: authentik-tls
        fieldPaths:
          - spec.dnsNames.0
      - select:
          kind: IngressRoute
          name: authentik
        fieldPaths:
          - spec.routes.0.match
        options:
          delimiter: "`"
          index: 1

  # Set database storage size
  - sourceValue: 1Gi
    targets:
      - select:
          kind: Cluster
          name: authentik-db
        fieldPaths:
          - spec.storage.size

  # Make WAL archive server name unique per environment
  - sourceValue: authentik-db-dev
    targets:
      - select:
          kind: Cluster
          name: authentik-db
        fieldPaths:
          - spec.backup.barmanObjectStore.serverName

patches:
  # Authentik server manages API access and primary logic
  - target:
      kind: Deployment
      name: authentik-server
    patch: |-
      - op: test
        path: /spec/template/spec/containers/0/name
        value: server
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 768Mi

  # Authentik worker handles background tasks and async operations
  - target:
      kind: Deployment
      name: authentik-worker
    patch: |-
      - op: test
        path: /spec/template/spec/containers/0/name
        value: worker
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 768Mi

  # PostgreSQL Cluster resources optimized for stability
  - target:
      kind: Cluster
      name: authentik-db
    patch: |-
      - op: add
        path: /spec/resources
        value:
          requests:
            cpu: 20m
            memory: 128Mi
          limits:
            cpu: 250m
            memory: 192Mi
