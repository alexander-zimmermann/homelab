apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

replacements:
  # Inject domain name into the Certificate and IngressRoute
  - sourceValue: auth.zimmermann.sh
    targets:
      - select:
          kind: Certificate
          name: authentik-tls
        fieldPaths:
          - spec.dnsNames.0
      - select:
          kind: IngressRoute
          name: authentik
        fieldPaths:
          - spec.routes.0.match
        options:
          delimiter: "`"
          index: 1

  # Set database storage size
  - sourceValue: 5Gi
    targets:
      - select:
          kind: Cluster
          name: authentik-db
        fieldPaths:
          - spec.storage.size

  # Make WAL archive server name unique per environment
  - sourceValue: authentik-db-prod
    targets:
      - select:
          kind: Cluster
          name: authentik-db
        fieldPaths:
          - spec.backup.barmanObjectStore.serverName

patches:
  # Authentik server manages API access and primary logic
  - target:
      kind: Deployment
      name: authentik-server
    patch: |-
      - op: test
        path: /spec/template/spec/containers/0/name
        value: server
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi

  # Authentik worker handles background tasks
  - target:
      kind: Deployment
      name: authentik-worker
    patch: |-
      - op: test
        path: /spec/template/spec/containers/0/name
        value: worker
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi

  # PostgreSQL Cluster resources optimized for stability
  - target:
      kind: Cluster
      name: authentik-db
    patch: |-
      - op: add
        path: /spec/resources
        value:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi

  # Authentik service with static IP and BGP advertisement
  - target:
      kind: Service
      name: authentik-server
    patch: |-
      - op: add
        path: /metadata/annotations/io.cilium~1lb-ipam-ips
        value: "192.168.10.30"
