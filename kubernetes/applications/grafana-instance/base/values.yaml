# RBAC & Permissions
rbac:
  # Allows Grafana to retrieve metadata about services and pods for service discovery
  extraClusterRoleRules:
    - apiGroups: [""]
      resources: ["services", "endpoints", "pods"]
      verbs: ["get", "list", "watch"]

# Service Account
serviceAccount:
  # Explicit name for the ServiceAccount for better traceability
  name: grafana


# Pod Metadata
podLabels:
  # Additional label for consistent selectors in services and network policies
  component: grafana-server

# Administrator Access
admin:
  # Reference to a SealedSecret containing the username and password
  existingSecret: "grafana-admin-credentials"
  userKey: admin-user
  passwordKey: admin-password

# Secret Mounts
extraSecretMounts:
  # Mount the admin credentials secret into the container for grafana.ini access
  - name: grafana-admin-credentials
    secretName: grafana-admin-credentials
    defaultMode: 0440
    mountPath: /etc/grafana/secrets
    readOnly: true

# Primary Configuration (grafana.ini)
grafana.ini:
  security:
    admin_user: admin
    admin_password_file: /etc/grafana/secrets/admin-password

# Sidecar Configuration (Auto-import)
sidecar:
  dashboards:
    enabled: true
    searchNamespace: ALL
  datasources:
    enabled: true
    searchNamespace: ALL

# Image Rendering (PNG Exports)
imageRenderer:
  enabled: true
  networkPolicy:
    limitIngress: false

# Network Security
networkPolicy:
  enabled: true
  # Disallow external access not coming through the ingress controller
  allowExternal: false
  # Allow access only from defined namespaces (Ingress, Operator, Instance-local)
  explicitNamespacesSelector:
    matchExpressions:
      - key: kubernetes.io/metadata.name
        operator: In
        values:
          - ingress-controller
          - grafana-operator
          - grafana-instance
  # Define allowed egress for DNS, metrics (Prometheus), and logs (Loki)
  egress:
    enabled: true
    ports:
      - port: 53
        protocol: UDP
      - port: 53
        protocol: TCP
      - port: 8081
        protocol: TCP
      - port: 80
        protocol: TCP
      - port: 443
        protocol: TCP
      - port: 9090
        protocol: TCP
      - port: 3100
        protocol: TCP

extraObjects:
  # Register the Grafana instance with the Grafana Operator for advanced management
  - apiVersion: grafana.integreatly.org/v1beta1
    kind: Grafana
    metadata:
      name: grafana
    spec:
      external:
        url: "http://grafana.grafana-instance.svc.cluster.local:80"
        adminUser:
          name: grafana-admin-credentials
          key: admin-user
        adminPassword:
          name: grafana-admin-credentials
          key: admin-password
