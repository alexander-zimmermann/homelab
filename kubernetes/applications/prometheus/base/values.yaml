# Use a stable, short name for all rendered resources
fullnameOverride: prometheus

# Reduce duplicate prefixes for objects created by the Prometheus Operator
cleanPrometheusOperatorObjectNames: true

# Grafana runs as a separate app
grafana:
  enabled: false

# Disable exporters/components that are provided elsewhere
kubeStateMetrics:
  enabled: false

nodeExporter:
  enabled: false

alertmanager:
  alertmanagerSpec:
    # Persist Alertmanager state
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes:
            - ReadWriteOnce

prometheus:
  # Expose Prometheus service via Cilium/BGP-announced LoadBalancer
  service:
    type: LoadBalancer
    labels:
      bgp.cilium.io/ip-pool: default
      bgp.cilium.io/advertise-service: default

  prometheusSpec:
    # Required for remote_write receiver (e.g. for agent-based ingestion)
    enableRemoteWriteReceiver: true

    # Opt-In Model: Only scrape ServiceMonitors/PodMonitors with 'release: prometheus'
    serviceMonitorSelector:
      matchLabels:
        release: prometheus
    podMonitorSelector:
      matchLabels:
        release: prometheus

    # Apply this label to all resources created by the operator (including default monitors)
    commonLabels:
      release: prometheus

    # Reduces TSDB disk usage by approx. 30-40% with minimal CPU overhead
    walCompression: true

    # Stability guards to prevent OOM kills from heavy queries or dashboards
    additionalArgs:
      - name: query.max-concurrency
        value: "5"
      - name: query.timeout
        value: "30s"
      - name: query.max-samples
        value: "5000000"

    # Persist TSDB data
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes:
            - ReadWriteOnce

# Component-specific scraping optimizations
kubeApiServer:
  serviceMonitor:
    metricRelabelings:
      # Drop all histogram buckets for request durations/sizes to reduce cardinality
      # Keeping only _sum and _count
      # Note: etcd metrics are also reported by the apiserver job
      - action: drop
        regex: (apiserver_request_duration_seconds_bucket|apiserver_request_slo_duration_seconds_bucket|apiserver_request_sli_duration_seconds_bucket|apiserver_request_body_size_bytes_bucket|etcd_request_duration_seconds_bucket)
        sourceLabels: [__name__]
