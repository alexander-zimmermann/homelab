# Talos configures the kube-controller-manager to handle PodCIDRs (via Node resources),
# so we use 'mode: kubernetes' instead of 'cluster-pool' to align with the upstream source of truth.
ipam:
  mode: kubernetes

# Native routing: use direct host routing for performance and transparency
ipv4NativeRoutingCIDR: 10.244.0.0/16
routingMode: native

# Performance: optimize routing between nodes sharing a common L2 segment
autoDirectNodeRoutes: true

# Efficiency: complete replacement of legacy kube-proxy with BPF logic
kubeProxyReplacement: true

# Performance: use native BPF-based masquerading instead of iptables
bpf:
  masquerade: true

# Enable BGP control plane for network peering; utilize the central 'cilium'
# namespace for peering secrets to avoid namespace sprawl
bgpControlPlane:
  enabled: true
  secretsNamespace:
    create: false
    name: cilium

# Target the internal Kubernetes API server endpoint
k8sServiceHost: localhost
k8sServicePort: '7445'

# Talos compatibility: use the standard system cgroup mount path
cgroup:
  autoMount:
    enabled: false
  hostRoot: /sys/fs/cgroup

# Talos-specific hardening: remove SYS_MODULE as Talos has an immutable kernel
# and doesn't allow runtime module loading
securityContext:
  capabilities:
    ciliumAgent:
      - CHOWN
      - KILL
      - NET_ADMIN
      - NET_RAW
      - IPC_LOCK
      - SYS_ADMIN
      - SYS_RESOURCE
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    cleanCiliumState:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_RESOURCE

# Centralize TLS certificates in the 'cilium' namespace for agents to access
tls:
  secretsNamespace:
    create: false
    name: cilium

# Hubble network observability
hubble:
  # Enable flow metrics for advanced observability (drops, dns, tcp, etc.)
  metrics:
    enableOpenMetrics: true
    enabled:
    - dns:query;ignoreAAAA
    - drop
    - tcp
    - flow
    - port-distribution
    - icmp
    - http

  # Enable Hubble Relay to aggregate data from all nodes
  relay:
    enabled: true
    networkPolicy:
      enabled: true
      ingress:
        - from:
          - podSelector:
              matchLabels:
                k8s-app: hubble-ui

  # Hubble UI for visualization
  ui:
    enabled: true
    networkPolicy:
      enabled: true
      ingress:
        - from:
          - namespaceSelector:
              matchLabels:
                kubernetes.io/metadata.name: ingress-controller
            podSelector:
              matchLabels:
                app.kubernetes.io/name: traefik

  # Grafana Dashboards for Hubble
  dashboards:
    enabled: true
    label: grafana_dashboard

# Grafana Dashboards for Cilium Agent
dashboards:
  enabled: true
  label: grafana_dashboard

# Prometheus: Enable metrics for Cilium agent and create ServiceMonitor
prometheus:
  enabled: true
  serviceMonitor:
    enabled: true

# Operator: Manage Cilium state
operator:
  # Homelab optimization: Single replica is sufficient and saves resources
  replicas: 1
  # Enable metrics for the operator
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true

  # Grafana Dashboards for Operator
  dashboards:
    enabled: true
    label: grafana_dashboard
