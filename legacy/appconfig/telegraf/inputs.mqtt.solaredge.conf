# =======================================================
# Read metrics from MQTT topic(s)
# =======================================================
[[inputs.mqtt_consumer]]
  ## Broker URLs for the MQTT server or cluster
  servers = ["tcp://mqtt.zimmermann.eu.com:1883"]

  ## Username and password to connect MQTT server
  username = "telegraf"
  password = "@{docker_secretstore:telegraf_mqtt_password}"

  ## Data format to consume.
  ## https://github.com/influxdata/telegraf/blob/master/docs/DATA_FORMATS_INPUT.md
  data_format = "xpath_json"

  ## Topics that will be subscribed to
  topics = ["solaredge/modbus/inverter"]

  ## Keep native JSON types where possible
  xpath_native_types = true

  ## Optionally print the parsed internal document for debugging
  xpath_print_document = false

  ## One or more xpath parsing sections:
  [[inputs.mqtt_consumer.xpath]]
    ## Select the document root (process the whole JSON object)
    metric_selection = "/"

    ## Force a measurement name
    metric_name = "string('solaredge.inverter')"

    ## Extract info.* values as tags (results ALWAYS converted to strings)
    [inputs.mqtt_consumer.xpath.tags]
      manufacturer = "/info/manufacturer"
      model        = "/info/model"
      version      = "/info/version"
      serialnumber = "/info/serialnumber"

    ## Non-integer fields. Use XPath functions like number() to convert to numeric types.
    [inputs.mqtt_consumer.xpath.fields]
      ## AC currents
      ac_current_actual = "number(/ac/current/actual)"
      ac_current_l1     = "number(/ac/current/l1)"
      ac_current_l2     = "number(/ac/current/l2)"
      ac_current_l3     = "number(/ac/current/l3)"

      ## AC voltages
      ac_voltage_l1     = "number(/ac/voltage/l1)"
      ac_voltage_l2     = "number(/ac/voltage/l2)"
      ac_voltage_l3     = "number(/ac/voltage/l3)"

      ## AC power
      ac_power_actual   = "number(/ac/power/actual)"
      ac_power_reactive = "number(/ac/power/reactive)"
      ac_power_apparent = "number(/ac/power/apparent)"
      ac_power_factor   = "number(/ac/power/factor)"

      ## AC Frequency
      ac_frequency      = "number(/ac/frequency)"

      # DC
      dc_current        = "number(/dc/current)"
      dc_voltage        = "number(/dc/voltage)"
      dc_power          = "number(/dc/power)"

      # Other numeric fields
      energytotal       = "number(/energytotal)"
      temperature       = "number(/temperature)"


# =======================================================
# Read metrics from MQTT topic(s)
# =======================================================
[[inputs.mqtt_consumer]]
  ## Broker URLs for the MQTT server or cluster
  servers = ["tcp://mqtt.zimmermann.eu.com:1883"]

  ## Username and password to connect MQTT server
  username = "telegraf"
  password = "@{docker_secretstore:telegraf_mqtt_password}"

  ## Data format to consume.
  ## https://github.com/influxdata/telegraf/blob/master/docs/DATA_FORMATS_INPUT.md
  data_format = "xpath_json"

  ## Topics that will be subscribed to
  topics = ["solaredge/powerflow"]

  ## Keep native JSON types where possible
  xpath_native_types = true

  ## Optionally print the parsed internal document for debugging
  xpath_print_document = false

  ## One or more xpath parsing sections:
  [[inputs.mqtt_consumer.xpath]]
    ## Select the document root (process the whole JSON object)
    metric_selection = "/"

    ## Force a measurement name
    metric_name = "string('solaredge.powerflow')"

    ## Non-integer fields. Use XPath functions like number() to convert to numeric types.
    [inputs.mqtt_consumer.xpath.fields]
      ## Inverter
      inverter_power                   = "number(/inverter/power)"
      inverter_dc_power                = "number(/inverter/dc_power)"
      inverter_consumption             = "number(/inverter/consumption)"
      inverter_production              = "number(/inverter/production)"
      inverter_battery_production      = "number(/inverter/battery_production)"
      inverter_pv_production           = "number(/inverter/pv_production)"

      ## Grid
      grid_power                       = "number(/grid/power)"
      grid_consumption                 = "number(/grid/consumption)"
      grid_delivery                    = "number(/grid/delivery)"

      ## Battery
      battery_power                    = "number(/battery/charge)"
      battery_charge                   = "number(/battery/reactive)"
      battery_discharge                = "number(/battery/discharge)"

      # Consumer
      consumer_house                   = "number(/consumer/house)"
      consumer_evcharger               = "number(/consumer/evcharger)"
      consumer_inverter                = "number(/consumer/inverter)"
      consumer_used_production         = "number(/consumer/used_production)"
      consumer_total                   = "number(/consumer/total)"
      consumer_used_battery_production = "number(/consumer/used_battery_production)"
      consumer_used_pv_production      = "number(/consumer/used_pv_production)"

      # Other numeric fields
      pv_production                    = "number(/pv_production)"
