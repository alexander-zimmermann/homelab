# =======================================================
# Read metrics from MQTT topic
# =======================================================
[[inputs.mqtt_consumer]]
  ## Broker URLs for the MQTT server or cluster
  servers = ["tcp://mqtt.zimmermann.eu.com:1883"]

  ## Username and password to connect MQTT server
  username = "telegraf"
  password = "@{docker_secretstore:telegraf_mqtt_password}"

  ## Data format to consume
  ## https://github.com/influxdata/telegraf/blob/master/docs/DATA_FORMATS_INPUT.md
  data_format = "json"

  ## Topics that will be subscribed to
  topics = [
	"warp/evse/state",
	"warp/charge_tracker/state",
	"warp/charge_tracker/current_charge",
  ]

  ## Enable extracting tag values from MQTT topics
  ## _ denotes an ignored entry in the topic path,
  ## # denotes a variable length path element (can only be used once per setting)
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "warp/+/+"
    measurement = "measurement/_/_"


# =======================================================
# Read metrics from MQTT topic
# =======================================================
[[inputs.mqtt_consumer]]
  ## Broker URLs for the MQTT server or cluster
  servers = ["tcp://mqtt.zimmermann.eu.com:1883"]

  ## Username and password to connect MQTT server
  username = "telegraf"
  password = "@{docker_secretstore:telegraf_mqtt_password}"

  ## Data format to consume
  ## https://github.com/influxdata/telegraf/blob/master/docs/DATA_FORMATS_INPUT.md
  data_format = "xpath_json"

  ## Topics that will be subscribed to
  topics = [
	"warp/charge_tracker/last_charges",
  ]

  ## Keep native JSON types where possible
  xpath_native_types = true

  ## Optionally print the parsed internal document for debugging
  # xpath_print_document = false

  ## Enable extracting tag values from MQTT topics
  ## _ denotes an ignored entry in the topic path,
  ## # denotes a variable length path element (can only be used once per setting)
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "warp/charge_tracker/last_charges"
    measurement = "measurement/_/_"

  ## Parse XML document
  [[inputs.mqtt_consumer.xpath]]
    ## XPath-query to select a subset of nodes from the XML document
	metric_selection = "descendant::*"

    ## Field definitions using XPath queries
	[inputs.mqtt_consumer.xpath.fields]
	  charge_duration = "charge_duration"
	  energy_charged = "energy_charged"

    ## Tag definitions using the given XPath queries
	[inputs.mqtt_consumer.xpath.tags]
	  user_id = "user_id"
	  timestamp_minutes = "timestamp_minutes"


# =======================================================
# Read metrics from MQTT topic
# =======================================================
[[inputs.mqtt_consumer]]
  ## Broker URLs for the MQTT server or cluster
  servers = ["tcp://mqtt.zimmermann.eu.com:1883"]

  ## Username and password to connect MQTT server
  username = "telegraf"
  password = "@{docker_secretstore:telegraf_mqtt_password}"

  ## Data format to consume
  ## https://github.com/influxdata/telegraf/blob/master/docs/DATA_FORMATS_INPUT.md
  data_format = "xpath_json"

  ## Topics that will be subscribed to
  topics = [
	"warp/meters/0/values",
  ]

  ## Keep native JSON types where possible
  xpath_native_types = true

  ## Optionally print the parsed internal document for debugging
  # xpath_print_document = false

  ## Enable extracting tag values from MQTT topics
  ## _ denotes an ignored entry in the topic path,
  ## # denotes a variable length path element (can only be used once per setting)
  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "warp/meters/0/values"
    measurement = "measurement/_/_/_"

  ## Parse XML document
  [[inputs.mqtt_consumer.xpath]]

    ## Field definitions using XPath queries
    [inputs.mqtt_consumer.xpath.fields]
      ## Voltage L1, L2, L3
      voltage_L1 = "//*[1]"
      voltage_L2 = "//*[2]"
      voltage_L3 = "//*[3]"
      ## Current L1, L2, L3
      current_L1 = "//*[4]"
      current_L2 = "//*[5]"
      current_L3 = "//*[6]"
      ## Power L1, L2, L3
      power_L1 = "//*[7]"
      power_L2 = "//*[8]"
      power_L3 = "//*[9]"


# =======================================================
# Set correct timestamp for metric "last_charges"
# =======================================================
[[processors.starlark]]
  ## additional filter
  namepass = ["warp"]

  ## start of starlark script
  source = '''

load("logging.star", "log")
load("time.star", "time")

def apply(metric):
  ## Only modify "warp/charge_tracker/last_charges" topic
  if not metric.tags.get("topic") == "warp/charge_tracker/last_charges":
      return metric

  ## Calculate UNIX timestamp
  unix_ts = int(float(metric.tags["timestamp_minutes"]) * 60)

  ## Set timestamp for metric
  metric.tags["timestamp"] = str(unix_ts)
  metric.time = time.from_timestamp(unix_ts).unix_nano

  ## Delete old timestamp tag
  metric.tags.pop("timestamp_minutes")

  return metric
'''
