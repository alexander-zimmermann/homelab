---
###############################################################################
## Global cluster definition
###############################################################################
kind: Cluster
name: homelab
kubernetes:
  version: v1.32.0
talos:
  version: v1.12.0
features:
  diskEncryption: true # Full disk encryption (LUKS) on all nodes

## Global patches, applied to ALL nodes (both control plane and data plane)
patches:
  - name: global-settings
    inline:
      ## Cluster-wide network settings
      cluster:
        network:
          cni:
            name: none # Disable default CNI (Flannel) to allow Cilium installation
        proxy:
          disabled: true # Disable KubeProxy (Cilium Replacement Mode)

      ## Machine-level settings
      machine:
        ## Load required kernel modules
        kernel:
          modules:
            - name: zfs # Required for ZFS storage

        ## Network sysctls required for Cilium
        sysctls:
          net.ipv4.ip_forward: "1"
          net.ipv6.conf.all.forwarding: "1"

        ## Kubelet security and bootstrap config
        kubelet:
          extraArgs:
            rotate-server-certificates: "true" # Enable kubelet serving cert rotation
          extraConfig:
            serverTLSBootstrap: true # Allow kubelet to request TLS certs

        ## NTP Time Synchronization
        time:
          servers:
            - time.cloudflare.com
            - pool.ntp.org

        ## Talos specific features
        features:
          kubePrism:
            enabled: true
            port: 7445 # Localhost loadbalancer for K8s API (HA reliability)
          hostDNS:
            enabled: true
            forwardKubeDNSToHost: true # Forward DNS from pods to host resolver

---
###############################################################################
## Control Plane definition
###############################################################################
kind: ControlPlane
machineClass:
  name: control-plane-prod
  size: 1

patches:
  - name: cp-settings
    inline:
      ## Control plane specific machine config
      machine:
        features:
          ## Enable Talos API access from within Kubernetes
          ## Required for the Talos Cloud Controller Manager (CCM) to function
          kubernetesTalosAPIAccess:
            enabled: true
            allowedRoles:
              - os:reader
            allowedKubernetesNamespaces:
              - kube-system

---
###############################################################################
## Data plane definition
###############################################################################
kind: Workers
machineClass:
  name: data-plane-prod
  size: 3

## Update Strategies
## Critical for storage nodes: Ensure only one node reboots at a time to maintain data availability.
updateStrategy:
  rolling:
    maxParallelism: 1
deleteStrategy:
  type: Rolling
  rolling:
    maxParallelism: 1

patches:
  - name: worker-settings
    inline:
      ## Data plane specific cluster config
      cluster:
        ## Inject UserVolumeConfig for Longhorn Disk Partitioning
        ## This creates the partition on the extra disk (!system_disk)
        inlineManifests:
          - name: longhorn-vol-config
            contents: |
              apiVersion: v1alpha1
              kind: UserVolumeConfig
              name: longhorn
              provisioning:
                diskSelector:
                  match: "!system_disk"
                minSize: 10G
              filesystem:
                type: ext4

      ## Data plane specific machine config
      machine:
        ## Kubernetes Node Role Label
        nodeLabels:
          node-role.kubernetes.io/data-plane: ""

        ## Mounts for Longhorn Storage
        ## Binds the physical mount point into the Kubelet container
        kubelet:
          extraMounts:
            - destination: /var/mnt/longhorn
              type: bind
              source: /var/mnt/longhorn
              options:
                - bind
                - rshared
                - rw
