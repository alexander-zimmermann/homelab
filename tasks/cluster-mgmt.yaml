---
version: "3"

tasks:
  classes:
    desc: "Apply machine classes (omnictl apply)"
    preconditions:
      - sh: command -v omnictl
        msg: "omnictl is not installed"
      - sh: test -f manifest/machine-classes.yaml
        msg: "manifest/machine-classes.yaml is missing"
    cmds:
      - cmd: printf "{{.BLUE}}ðŸ­ Applying Machine Classes...{{.RESET}}\n"
        silent: true
      - omnictl apply -f manifest/machine-classes.yaml
      - cmd: printf "{{.GREEN}}âœ… Machine Classes applied.{{.RESET}}\n"
        silent: true

  validate:
    desc: "Validate cluster template (usage: task cluster:validate -- CLUSTER ENV)"
    vars:
      CLUSTER: "{{if gt (len .CLI_ARGS_LIST) 0}}{{index .CLI_ARGS_LIST 0}}{{end}}"
      ENV: "{{if gt (len .CLI_ARGS_LIST) 1}}{{index .CLI_ARGS_LIST 1}}{{end}}"
      MANIFEST: "manifest/{{.CLUSTER}}-cluster-{{.ENV}}.yaml"
    preconditions:
      - sh: command -v omnictl
        msg: "omnictl is not installed"
      - sh: test -n "{{.CLUSTER}}" && test -n "{{.ENV}}"
        msg: "Usage: task cluster:validate -- CLUSTER ENV"
      - sh: test -f "{{.MANIFEST}}"
        msg: "Manifest not found: {{.MANIFEST}}"
    cmds:
      - cmd: printf "{{.BLUE}}ðŸ” Validating Cluster Template for {{.CLUSTER}} ({{.ENV}})...{{.RESET}}\n"
        silent: true
      - omnictl cluster template validate -f "{{.MANIFEST}}"
      - cmd: printf "{{.GREEN}}âœ… Cluster Template is valid.{{.RESET}}\n"
        silent: true

  sync:
    desc: "Sync cluster template (usage: task cluster:sync -- CLUSTER ENV)"
    vars:
      CLUSTER: "{{if gt (len .CLI_ARGS_LIST) 0}}{{index .CLI_ARGS_LIST 0}}{{end}}"
      ENV: "{{if gt (len .CLI_ARGS_LIST) 1}}{{index .CLI_ARGS_LIST 1}}{{end}}"
      MANIFEST: "manifest/{{.CLUSTER}}-cluster-{{.ENV}}.yaml"
    deps: [validate]
    preconditions:
      - sh: command -v omnictl
        msg: "omnictl is not installed"
      - sh: test -n "{{.CLUSTER}}" && test -n "{{.ENV}}"
        msg: "Usage: task cluster:sync -- CLUSTER ENV"
      - sh: test -f "{{.MANIFEST}}"
        msg: "Manifest not found: {{.MANIFEST}}"
    cmds:
      - cmd: printf "{{.BLUE}}ðŸ”„ Syncing Cluster Template for {{.CLUSTER}} {{.ENV}})...{{.RESET}}\n"
        silent: true
      - omnictl cluster template sync -f "{{.MANIFEST}}"
      - cmd: printf "{{.GREEN}}âœ… Cluster Template synced.{{.RESET}}\n"
        silent: true

  status:
    desc: "Show cluster status (usage: task cluster:status -- CLUSTER ENV)"
    vars:
      CLUSTER: "{{if gt (len .CLI_ARGS_LIST) 0}}{{index .CLI_ARGS_LIST 0}}{{end}}"
      ENV: "{{if gt (len .CLI_ARGS_LIST) 1}}{{index .CLI_ARGS_LIST 1}}{{end}}"
      MANIFEST: "manifest/{{.CLUSTER}}-cluster-{{.ENV}}.yaml"
    preconditions:
      - sh: command -v omnictl
        msg: "omnictl is not installed"
      - sh: test -n "{{.CLUSTER}}" && test -n "{{.ENV}}"
        msg: "Usage: task cluster:status -- CLUSTER ENV"
      - sh: test -f "{{.MANIFEST}}"
        msg: "Manifest not found: {{.MANIFEST}}"
    cmds:
      - cmd: printf "{{.BLUE}}ðŸ“Š Checking Cluster Status for {{.CLUSTER}} ({{.ENV}})...{{.RESET}}\n"
        silent: true
      - omnictl cluster template status -f "{{.MANIFEST}}"
      - cmd: printf "{{.GREEN}}âœ… Status check complete.{{.RESET}}\n"
        silent: true

  config:
    desc: "Download cluster credentials (usage: task cluster:config -- CLUSTER)"
    vars:
      CLUSTER: "{{if gt (len .CLI_ARGS_LIST) 0}}{{index .CLI_ARGS_LIST 0}}{{end}}"
    preconditions:
      - sh: command -v omnictl
        msg: "omnictl is not installed"
      - sh: test -n "{{.CLUSTER}}"
        msg: "Usage: task cluster:config -- CLUSTER"
    cmds:
      - cmd: printf "{{.BLUE}}ðŸ“¥ Downloading Credentials for {{.CLUSTER}}...{{.RESET}}\n"
        silent: true
      - mkdir -p {{.BUILD_DIR}}
      - omnictl kubeconfig --cluster "{{.CLUSTER}}" > "{{.BUILD_DIR}}/kubeconfig_{{.CLUSTER}}.yaml"
      - omnictl talosconfig --cluster "{{.CLUSTER}}" > "{{.BUILD_DIR}}/talosconfig_{{.CLUSTER}}.yaml"
      - cmd: printf "{{.GREEN}}âœ… Credentials saved to {{.BUILD_DIR}}/kubeconfig_{{.CLUSTER}}.yaml{{.RESET}}\n"
        silent: true
