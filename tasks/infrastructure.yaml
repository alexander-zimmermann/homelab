---
version: "3"

tasks:
  prepare:
    desc: "Prepare Terraform/OpenTofu environment (tofu init)"
    dir: infrastructure
    cmds:
      - cmd: printf "{{.BLUE}}ğŸ—ï¸  Initializing OpenTofu...{{.RESET}}\n"
        silent: true
      - mkdir -p build
      - tofu init
      - cmd: printf "{{.GREEN}}âœ… OpenTofu initialized!{{.RESET}}\n"
        silent: true

  plan:
    desc: "Generate plan for infrastructure deployment"
    dir: infrastructure
    deps: [prepare]
    cmds:
      - cmd: printf "{{.BLUE}}ğŸ•µï¸  Generating infrastructure plan...{{.RESET}}\n"
        silent: true
      - tofu plan -out tfplan
      - cmd: printf "{{.GREEN}}âœ… Plan generated (tfplan){{.RESET}}\n"
        silent: true

  apply:
    desc: "Apply planned infrastructure changes to Proxmox (OpenTofu apply)"
    dir: infrastructure
    deps: [plan]
    preconditions:
      - sh: test -f tfplan
        msg: "tfplan is missing â€“ run 'task infra:plan' first."
    cmds:
      - cmd: printf "{{.BLUE}}ğŸš€ Applying infrastructure changes...{{.RESET}}\n"
        silent: true
      - tofu apply tfplan
      - cmd: printf "{{.GREEN}}âœ… Infrastructure applied!{{.RESET}}\n"
        silent: true

  refresh:
    desc: "Refresh infrastructure state (OpenTofu refresh)"
    dir: infrastructure
    cmds:
      - cmd: printf "{{.BLUE}}ğŸ”„ Refreshing infrastructure state...{{.RESET}}\n"
        silent: true
      - tofu refresh
      - cmd: printf "{{.GREEN}}âœ… Infrastructure state refreshed!{{.RESET}}\n"
        silent: true

  output:
    desc: "Show infrastructure outputs (OpenTofu output)"
    dir: infrastructure
    cmds:
      - cmd: printf "{{.BLUE}}ğŸ—ï¸ Showing infrastructure outputs...{{.RESET}}\n"
        silent: true
      - tofu output
      - cmd: printf "{{.GREEN}}âœ… Infrastructure outputs shown!{{.RESET}}\n"
        silent: true

  destroy:
    desc: "Destroy (tear down) all managed Proxmox infrastructure"
    dir: infrastructure
    cmds:
      - cmd: printf "{{.RED}}ğŸ’¥ Destroying infrastructure...{{.RESET}}\n"
        silent: true
      - tofu destroy -auto-approve
      - cmd: printf "{{.GREEN}}âœ… Infrastructure destroyed.{{.RESET}}\n"
        silent: true
