---
version: "3"

tasks:
  prepare:
    desc: "Initialize OpenTofu environment (tofu init)"
    preconditions:
      - sh: command -v tofu
        msg: "OpenTofu (tofu) is not installed"
    cmds:
      - cmd: printf "{{.BLUE}}ğŸ—ï¸  Initializing OpenTofu...{{.RESET}}\n"
        silent: true
      - mkdir -p build
      - tofu init
      - cmd: printf "{{.GREEN}}âœ… OpenTofu initialized!{{.RESET}}\n"
        silent: true

  plan:
    desc: "Generate infrastructure plan (tofu plan)"
    preconditions:
      - sh: test -d .terraform
        msg: ".terraform directory is missing. Run 'task infra:prepare' first."
    cmds:
      - cmd: printf "{{.BLUE}}ğŸ•µï¸  Generating infrastructure plan...{{.RESET}}\n"
        silent: true
      - tofu plan -out tfplan
      - cmd: printf "{{.GREEN}}âœ… Plan generated (tfplan){{.RESET}}\n"
        silent: true

  apply:
    desc: "Apply infrastructure changes (tofu apply)"
    deps: [plan]
    preconditions:
      - sh: test -f tfplan
        msg: "tfplan is missing â€“ run 'task infra:plan' first."
    cmds:
      - cmd: printf "{{.BLUE}}ğŸš€ Applying infrastructure changes...{{.RESET}}\n"
        silent: true
      - tofu apply tfplan
      - cmd: printf "{{.GREEN}}âœ… Infrastructure applied!{{.RESET}}\n"
        silent: true

  refresh:
    desc: "Refresh infrastructure state (tofu refresh)"
    preconditions:
      - sh: command -v tofu
        msg: "OpenTofu (tofu) is not installed"
      - sh: test -d .terraform
        msg: ".terraform directory is missing. Run 'task infra:prepare' first."
    cmds:
      - cmd: printf "{{.BLUE}}ğŸ”„ Refreshing infrastructure state...{{.RESET}}\n"
        silent: true
      - tofu refresh
      - cmd: printf "{{.GREEN}}âœ… Infrastructure state refreshed!{{.RESET}}\n"
        silent: true

  output:
    desc: "Show infrastructure outputs (tofu output)"
    preconditions:
      - sh: command -v tofu
        msg: "OpenTofu (tofu) is not installed"
      - sh: test -f terraform.tfstate
        msg: "terraform.tfstate is missing. Run 'task infra:apply' first."
    cmds:
      - cmd: printf "{{.BLUE}}ğŸ—ï¸ Showing infrastructure outputs...{{.RESET}}\n"
        silent: true
      - tofu output
      - cmd: printf "{{.GREEN}}âœ… Infrastructure outputs shown!{{.RESET}}\n"
        silent: true

  destroy:
    desc: "Destroy infrastructure resources (tofu destroy)"
    preconditions:
      - sh: command -v tofu
        msg: "OpenTofu (tofu) is not installed"
    cmds:
      - cmd: printf "{{.RED}}ğŸ’¥ Destroying infrastructure...{{.RESET}}\n"
        silent: true
      - tofu destroy -auto-approve
      - cmd: printf "{{.GREEN}}âœ… Infrastructure destroyed.{{.RESET}}\n"
        silent: true
