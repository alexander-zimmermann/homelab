version: "3"

tasks:
  create:
    desc: "apply sealed secrets key [env]"
    summary: |
      Apply Sealed Secrets master key.
      Arguments: [env] (default: prod)
      Underlying command: kubectl apply
    vars:
      ENVIRONMENT: "{{if gt (len .CLI_ARGS_LIST) 0}}{{index .CLI_ARGS_LIST 0}}{{else}}prod{{end}}"
    requires:
      vars:
        - name: ENVIRONMENT
          enum: [dev, prod]
    preconditions:
      - sh: command -v kubectl
        msg: "kubectl is not installed"
      - sh: test -f kubernetes/.secrets/sealed-secrets-key.yaml
        msg: "kubernetes/.secrets/sealed-secrets-key.yaml not found. Cluster bootstrap requires sealed secrets key."
      - sh: test -f kubernetes/.secrets/dhi-registry-credentials.yaml
        msg: "kubernetes/.secrets/dhi-registry-credentials.yaml not found. Cluster bootstrap requires DHI credentials."
    cmds:
      # wait for Kubernetes API readiness (trigger OIDC flow if needed)
      - kubectl cluster-info
      # inject sealed secrets master key
      - kubectl apply -f kubernetes/.secrets/sealed-secrets-key.yaml
      # inject dhi registry credentials (needed for sealed-secrets-controller bootstrap)
      - kubectl create namespace sealed-secrets-controller --dry-run=client -o yaml | kubectl apply -f -
      - kubectl apply -f kubernetes/.secrets/dhi-registry-credentials.yaml
      - kubectl annotate secret dhi-registry-secret -n sealed-secrets-controller sealed-secrets.bitnami.com/managed="true" --overwrite

  delete:
    desc: "wipe all cluster resources"
    summary: |
      Wipe all cluster resources.
      Underlying command: kubectl delete ns
    vars:
      COMPONENTS_DIR: "kubernetes/components"
      MANAGED_NAMESPACES:
        sh: |
          grep -rh "namespace:" {{.COMPONENTS_DIR}}/*/base/kustomization.yaml kubernetes/applications/*/base/kustomization.yaml \
          | awk '{print $2}' \
          | sort -u \
          | grep -vE '^(default|kube-system|kube-public|kube-node-lease)$' \
          | tr '\n' ' '
    preconditions:
      - sh: command -v kubectl
        msg: "kubectl is not installed"
    prompt: "Are you sure you want to wipe the cluster?"
    cmds:
      # async delete
      - echo "{{.MANAGED_NAMESPACES}}" | xargs kubectl delete ns --ignore-not-found=true --wait=false
      # force cleanup
      - cmd: |
          echo "Waiting for namespaces to terminate or force cleanup..."
          for ns in {{.MANAGED_NAMESPACES}}; do
            kubectl wait --for=delete ns/$ns --timeout=10s >/dev/null 2>&1 || true
            if kubectl get ns $ns >/dev/null 2>&1; then
              echo "Force removing finalizers for $ns..."
              kubectl patch ns $ns -p '{"spec":{"finalizers":[]}}' --type=merge >/dev/null 2>&1
            fi
          done
      # system component cleanup
      - kubectl delete secret hubble-tls-cert -n default --ignore-not-found=true

  status:
    desc: "verify cluster health"
    summary: |
      Verify cluster health and connectivity.
      Underlying command: kubectl get nodes/pods, cilium status
    preconditions:
      - sh: command -v kubectl
        msg: "kubectl is not installed"
      - sh: command -v cilium
        msg: "cilium-cli is not installed"
    cmds:
      - kubectl get nodes
      - kubectl get pods -A
      - cilium status -n cilium

  show:
    desc: "show admin credentials"
    summary: |
      Show important cluster secrets (ArgoCD admin).
      Underlying command: kubectl get secret
    preconditions:
      - sh: command -v kubectl
        msg: "kubectl is not installed"
    cmds:
      - echo "ArgoCD admin password is $(kubectl get secret/argocd-initial-admin-secret -n gitops-controller -o jsonpath='{.data.password}' | base64 -d)"
