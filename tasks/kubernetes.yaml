---
version: "3"

vars:
  TIMEOUT_CILIUM: "300s"
  TIMEOUT_ARGOCD: "300s"

  SCRIPTS_DIR: "kubernetes/scripts"
  BOOTSTRAP_DIR: "kubernetes/bootstrap"
  COMPONENTS_DIR: "kubernetes/components"
  HELM_CMD: "/opt/homebrew/opt/helm@3/bin/helm"

tasks:
  init:
    desc: "render kustomize manifests [env]"
    summary: |
      Generate inline patches for CNI and GitOps (Manifest Hydration).
      Arguments: [env] (default: prod)
      Underlying command: kustomize build | generate_patch.py
    vars:
      ENVIRONMENT: "{{if gt (len .CLI_ARGS_LIST) 0}}{{index .CLI_ARGS_LIST 0}}{{else}}prod{{end}}"
    requires:
      vars:
        - name: ENVIRONMENT
          enum: [dev, prod]
    sources:
      - "{{.COMPONENTS_DIR}}/cilium/overlays/{{.ENVIRONMENT}}/**"
      - "{{.COMPONENTS_DIR}}/gitops-controller/overlays/{{.ENVIRONMENT}}/**"
    generates:
      - "{{.BOOTSTRAP_DIR}}/patches/cilium-{{.ENVIRONMENT}}.yaml"
      - "{{.BOOTSTRAP_DIR}}/patches/argocd-{{.ENVIRONMENT}}.yaml"
    preconditions:
      - sh: command -v kustomize
        msg: "kustomize is not installed"
      - sh: command -v {{.PYTHON}}
        msg: "python3 is not installed"
      - sh: test -d {{.COMPONENTS_DIR}}
        msg: "{{.COMPONENTS_DIR}} is missing"
    cmds:
      - mkdir -p {{.BOOTSTRAP_DIR}}/patches/{{.ENVIRONMENT}}
      # Cilium
      - kustomize build --enable-helm --helm-command {{.HELM_CMD}} {{.COMPONENTS_DIR}}/cilium/overlays/{{.ENVIRONMENT}} | {{.PYTHON}} {{.SCRIPTS_DIR}}/generate_patch.py --target {{.BOOTSTRAP_DIR}}/patches/{{.ENVIRONMENT}}/cilium.yaml --name cilium
      # ArgoCD
      - kustomize build --enable-helm --helm-command {{.HELM_CMD}} {{.COMPONENTS_DIR}}/gitops-controller/overlays/{{.ENVIRONMENT}} | {{.PYTHON}} {{.SCRIPTS_DIR}}/generate_patch.py --target {{.BOOTSTRAP_DIR}}/patches/{{.ENVIRONMENT}}/argocd.yaml --name argocd
      # cleanup
      - rm -r {{.COMPONENTS_DIR}}/cilium/base/charts

  create:
    desc: "bootstrap kubernetes cluster [env]"
    summary: |
      Bootstrap the complete Kubernetes cluster (Zero-to-Hero).
      Arguments: [env] (default: prod)
      Pipeline: Render -> Sync -> Verify -> Secrets.
    vars:
      ENVIRONMENT: "{{if gt (len .CLI_ARGS_LIST) 0}}{{index .CLI_ARGS_LIST 0}}{{else}}prod{{end}}"
    requires:
      vars:
        - name: ENVIRONMENT
          enum: [dev, prod]
    deps: [init, "cluster:update"]
    preconditions:
      - sh: command -v kubectl
        msg: "kubectl is not installed"
      - sh: command -v cilium
        msg: "cilium-cli is not installed"
      - sh: test -f secrets/sealed-secrets-key.yaml
        msg: "secrets/sealed-secrets-key.yaml not found. Cluster bootstrap requires sealed secrets key."
    cmds:
      # wait for Kubernetes API readiness
      - until kubectl get --raw /healthz >/dev/null 2>&1; do sleep 5; done
      # wait for Cilium readiness
      - kubectl rollout status ds/cilium -n cilium --timeout={{.TIMEOUT_CILIUM}}
      - kubectl rollout status deploy/cilium-operator -n cilium --timeout={{.TIMEOUT_CILIUM}}
      - cilium status -n cilium --wait
      # wait for ArgoCD readiness
      - until kubectl get pods -n gitops-controller -l app.kubernetes.io/name=argocd-server >/dev/null 2>&1; do sleep 5; done
      - kubectl -n gitops-controller wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server --timeout={{.TIMEOUT_ARGOCD}}
      # inject sealed secrets master key
      - kubectl apply -f .secrets/sealed-secrets-key.yaml
      # wait for sealed secrets controller app
      - until kubectl get application -n gitops-controller sealed-secrets-controller-{{.ENVIRONMENT}} >/dev/null 2>&1; do sleep 5; done
      - kubectl wait application/sealed-secrets-controller-{{.ENVIRONMENT}} -n gitops-controller --for=jsonpath='{.status.health.status}'=Healthy --timeout=300s

  delete:
    desc: "complete cluster wipe"
    summary: |
      Wipe all cluster resources.
      Underlying command: kubectl delete ns
    vars:
      COMPONENTS_DIR: "kubernetes/components"
      MANAGED_NAMESPACES:
        sh: |
          grep -rh "namespace:" {{.COMPONENTS_DIR}}/*/base/kustomization.yaml kubernetes/applications/*/base/kustomization.yaml \
          | awk '{print $2}' \
          | sort -u \
          | grep -vE '^(default|kube-system|kube-public|kube-node-lease)$' \
          | tr '\n' ' '
    preconditions:
      - sh: command -v kubectl
        msg: "kubectl is not installed"
    prompt: "Are you sure you want to wipe the cluster?"
    cmds:
      # async delete
      - echo "{{.MANAGED_NAMESPACES}}" | xargs kubectl delete ns --ignore-not-found=true --wait=false
      # force cleanup
      - cmd: |
          echo "Waiting for namespaces to terminate or force cleanup..."
          for ns in {{.MANAGED_NAMESPACES}}; do
            kubectl wait --for=delete ns/$ns --timeout=10s >/dev/null 2>&1 || true
            if kubectl get ns $ns >/dev/null 2>&1; then
              echo "Force removing finalizers for $ns..."
              kubectl patch ns $ns -p '{"spec":{"finalizers":[]}}' --type=merge >/dev/null 2>&1
            fi
          done
      # system component cleanup
      - kubectl delete secret hubble-tls-cert -n default --ignore-not-found=true

  show:
    desc: "show cluster credentials"
    summary: |
      Show important cluster secrets (ArgoCD admin).
    preconditions:
      - sh: command -v kubectl
        msg: "kubectl is not installed"
    cmds:
      - echo "ArgoCD admin password is $(kubectl get secret/argocd-initial-admin-secret -n gitops-controller -o jsonpath='{.data.password}' | base64 -d)"

  status:
    desc: "verify cluster health"
    summary: |
      Verify cluster health and connectivity.
      Underlying command: kubectl get nodes/pods, cilium status
    preconditions:
      - sh: command -v kubectl
        msg: "kubectl is not installed"
      - sh: command -v cilium
        msg: "cilium-cli is not installed"
    cmds:
      - kubectl get nodes
      - kubectl get pods -A
      - cilium status -n cilium
